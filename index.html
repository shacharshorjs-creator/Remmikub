<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>רמיקוב – מצב משחק (v2.34-ml)</title>
<meta name="theme-color" content="#0e1220">
<style>
  :root{--bg:#0e1220;--card:#151a2b;--ink:#eaf1ff;--muted:#9fb0c9;--line:rgba(255,255,255,.14);--chip:#0b1325;--accent:#63c9ff;--accent2:#8ae9c9;--good:#19d19b;--warn:#ffd166}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .container{width:min(980px,94vw);margin:0 auto;padding:112px 0 120px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type=text],input[type=number]{background:#0b152a;color:#fff;border:1px solid var(--line);border-radius:12px;padding:10px 12px}
  button{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;background:#1c2741;color:#fff}
  .accent{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0b1320;font-weight:800}
  .ghost{background:transparent;border:1px dashed var(--line)}
  .danger{background:#3a1c1c;color:#ffd9d9;border:1px solid #5a2a2a}
  .leader{display:flex;gap:10px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid var(--line);border-radius:12px;padding:10px 12px;display:flex;gap:10px;align-items:center}
  .rank{font-weight:900;width:28px;height:28px;display:grid;place-items:center;border-radius:50%;background:#0d1a2e;border:1px solid rgba(100,200,255,.45)}
  .pill{padding:6px 10px;border-radius:999px;background:#0b172d;border:1px solid var(--line)}
  .appbar{position:fixed;inset:0 0 auto 0;height:90px;background:rgba(8,12,24,.82);backdrop-filter:blur(12px);border-bottom:1px solid var(--line);z-index:10;display:flex;align-items:center}
  .appbar-inner{width:min(980px,94vw);margin:0 auto;display:flex;align-items:center;gap:12px;justify-content:space-between}
  .title{font-weight:800;letter-spacing:.2px}
  .ver{font-size:12px;padding:6px 10px;border-radius:999px;background:#0a1a2c;border:1px solid rgba(99,201,255,.4)}
  .bbar{position:fixed;left:0;right:0;bottom:0;height:96px;background:rgba(6,10,20,.9);backdrop-filter:blur(10px);border-top:1px solid var(--line);display:flex;align-items:center;z-index:12}
  .bbar-inner{width:min(980px,94vw);margin:0 auto;display:flex;align-items:center;gap:12px;justify-content:space-between}
  .mini{font-size:12px;color:#9fb0c9}
  .filebtn{appearance:none;-webkit-appearance:none;background:#1c2741;border:1px solid var(--line);color:#fff;border-radius:12px;padding:12px 16px}
  .filebtn:active{opacity:.85}
  .hidden{display:none}
</style>
</head>
<body>
<div class="appbar">
  <div class="appbar-inner">
    <div class="row">
      <div class="title">רמיקוב – מצב משחק</div>
      <div class="ver" id="verBadge">v2.34-ml</div>
      <span id="backendBadge" class="ver">TF: —</span>
    </div>
    <div class="row">
      <button type="button" id="resetBtn" class="danger">איפוס נקודות</button>
      <button type="button" id="toggleTrainer" class="accent">אימון מודל</button>
    </div>
  </div>
</div>

<div class="container">
  <section id="s1" class="card">
    <h2 style="margin:0">בחירת משתתפים (עד 4)</h2>
    <div class="row" style="margin-top:8px">
      <input id="n0" type="text" placeholder="שחקן/ית 1">
      <input id="n1" type="text" placeholder="שחקן/ית 2">
      <input id="n2" type="text" placeholder="אופציונלי">
      <input id="n3" type="text" placeholder="אופציונלי">
      <button type="button" class="accent" id="startBtn">התחל משחק</button>
    </div>
  </section>

  <section id="s2" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">לוח הובלה</h2>
      <button type="button" id="backBtn" class="ghost">↩ חזרה לשמות</button>
    </div>
    <div id="board" class="leader" style="margin-top:10px"></div>
    <div id="panels" style="margin-top:10px"></div>
  </section>

  <section id="trainer" class="card">
    <h2 style="margin-top:0">אימון מודל זיהוי (על המכשיר)</h2>
    <div class="mini">קלטים גלויים + fallback polling ל-iOS Chrome</div>
    <div class="row" style="margin-top:8px">
      <label>בחר/י מחלקה</label>
      <select id="cls">
        <option value="none">בחר/י מספר</option>
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option><option>13</option>
      </select>
    </div>
    <div class="row" style="gap:8px;margin-top:8px">
      <input id="filePick" class="filebtn" type="file" accept="image/*,.heic,.heif" multiple>
      <input id="filePickOne" class="filebtn" type="file" accept="image/*,.heic,.heif">
      <input id="filePickCam" class="filebtn" type="file" accept="image/*,.heic,.heif" capture="environment">
      <input id="filePickHeic" class="filebtn" type="file" accept="image/*,.heic,.heif" multiple>
    </div>
    <div class="row mini" id="countsRow" style="margin-top:6px">דוגמאות למספרים: (טרם אימון)</div>
    <div class="card" id="dbg" style="margin-top:8px"><div class="mini">Debug:</div><pre id="dbgLog" style="white-space:pre-wrap;max-height:160px;overflow:auto;margin:0"></pre></div>
    <div class="row"><span id="status" class="ver">אין מודל</span></div>
  </section>
</div>

<div class="bbar">
  <div class="bbar-inner">
    <div class="mini" id="footerNote">טוען…</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier@1.2.2"></script>
<script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

<script>
(function(){
  const dbg = (m)=>{ try{ const el=document.getElementById('dbgLog'); el.textContent += '\n'+m; el.scrollTop = el.scrollHeight; }catch(_){} };
  const footer = document.getElementById('footerNote');
  (async()=>{ try{ await tf.setBackend('webgl'); await tf.ready(); }catch(e){ await tf.setBackend('cpu'); } finally{ document.getElementById('backendBadge').textContent='TF: '+tf.getBackend(); footer.textContent='מוכן · v2.34-ml'; } } )();

  // --- Game minimal state ---
  const KEY='rummi_state_v234ml';
  let state={players:[]};
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  function render(){
    const board=document.getElementById('board'); board.innerHTML='';
    const sorted=state.players.slice().sort((a,b)=>b.points-a.points);
    sorted.forEach((p,i)=>{
      const div=document.createElement('div'); div.className='chip';
      div.innerHTML='<div class="rank">'+(i+1)+'</div><div>'+p.name+'</div><div style="margin-inline-start:auto">'+p.points+' נק׳</div>';
      board.appendChild(div);
    });
    const panels=document.getElementById('panels'); panels.innerHTML='';
    state.players.forEach(p=>{
      const card=document.createElement('div'); card.className='card';
      const h=document.createElement('h3'); h.textContent=p.name; card.appendChild(h);
      const row=document.createElement('div'); row.className='row';
      const inp=document.createElement('input'); inp.type='number'; inp.placeholder='+/-';
      const btn=document.createElement('button'); btn.textContent='הוסף/הפחת';
      const m10=document.createElement('button'); m10.textContent='-10';
      btn.onclick=()=>{ const d=Number(inp.value); if(!Number.isNaN(d)&&inp.value!==''){ p.points+=d; inp.value=''; save(); render(); } };
      m10.onclick=()=>{ p.points-=10; save(); render(); };
      row.appendChild(inp); row.appendChild(btn); row.appendChild(m10);
      card.appendChild(row); panels.appendChild(card);
    });
  }
  document.getElementById('startBtn').onclick=()=>{
    const names=['n0','n1','n2','n3'].map(id=>document.getElementById(id).value.trim()).filter(Boolean);
    const list=names.length?names:['שחקן 1','שחקן 2'];
    state.players=list.map((n,i)=>({id:String(i+1),name:n,points:0})); save();
    document.getElementById('s1').classList.add('hidden');
    document.getElementById('s2').classList.remove('hidden');
    render(); window.scrollTo({top:0,behavior:'smooth'});
  };
  document.getElementById('backBtn').onclick=()=>{ document.getElementById('s2').classList.add('hidden'); document.getElementById('s1').classList.remove('hidden'); };
  document.getElementById('resetBtn').onclick=()=>{ if(confirm('לאפס נקודות?')){ state.players.forEach(p=>p.points=0); save(); render(); } };

  // --- Trainer ---
  const classifier = knnClassifier.create(); let mobilenetModel=null;
  async function ensureEmbedder(){ if(!mobilenetModel) mobilenetModel = await mobilenet.load({version:2,alpha:0.35}); }
  function isHeic(f){ const n=(f.name||'').toLowerCase(); return f.type==='image/heic'||f.type==='image/heif'||n.endsWith('.heic')||n.endsWith('.heif'); }
  async function toJpegIfNeeded(f){ if(!isHeic(f)) return f; try{ const blob=await heic2any({blob:f,toType:'image/jpeg',quality:0.9}); return new File([blob], (f.name||'photo')+'.jpg', {type:'image/jpeg'}); }catch(_){ dbg('heic2any failed, using original'); return f; } }
  async function loadImageFromFile(f){ f=await toJpegIfNeeded(f); return new Promise((res,rej)=>{ const img=new Image(); const u=URL.createObjectURL(f); img.onload=()=>{ URL.revokeObjectURL(u); res(img); }; img.onerror=(e)=>{ URL.revokeObjectURL(u); rej(e); }; img.src=u; }); }

  const cls=document.getElementById('cls');
  const pickers=['filePick','filePickOne','filePickCam','filePickHeic'].map(id=>document.getElementById(id));

  async function handleFilesFromInput(inp){
    const files=inp.files;
    dbg('poll detected ('+inp.id+') '+(files?files.length:0));
    if(!files||!files.length) return;
    if(cls.value==='none'){ document.getElementById('status').textContent='בחר/י מספר לפני העלאה'; return; }
    await ensureEmbedder();
    let ok=0,fail=0; const arr=[...files].slice(0,20);
    for(let i=0;i<arr.length;i++){ try{ const img=await loadImageFromFile(arr[i]);
      const emb=tf.tidy(()=>{ let x=tf.browser.fromPixels(img).toFloat();
        const r=x.slice([0,0,0],[x.shape[0],x.shape[1],1]); const g=x.slice([0,0,1],[x.shape[0],x.shape[1],1]); const b=x.slice([0,0,2],[x.shape[0],x.shape[1],1]);
        const gray=r.mul(0.299).add(g.mul(0.587)).add(b.mul(0.114)); x=tf.concat([gray,gray,gray],2);
        x=tf.image.resizeBilinear(x,[224,224]); const o=tf.scalar(127.5); x=x.sub(o).div(o).expandDims(0); return mobilenetModel.infer(x,'conv_preds').as2D(1,1001); });
      classifier.addExample(emb, cls.value); emb.dispose(); ok++; document.getElementById('status').textContent='מאמן: '+ok+'/'+arr.length+' (נכשלו: '+fail+')'; await tf.nextFrame(); }
    catch(err){ fail++; document.getElementById('status').textContent='מאמן: '+ok+'/'+arr.length+' (נכשלו: '+fail+')'; dbg('ERR '+(err.message||err)); }
    }
    const ds=classifier.getClassifierDataset(); const keys=Object.keys(ds);
    document.getElementById('countsRow').textContent= keys.length? ('דוגמאות: '+keys.map(k=>k+': '+(ds[k].shape[0]||0)).join(' | ')):'אין דוגמאות';
    inp.value='';
  }

  pickers.forEach(inp=>{
    inp.addEventListener('change', async (e)=>{
      dbg(inp.id+' change ('+(inp.files?inp.files.length:0)+')');
      await handleFilesFromInput(inp);
    });
    // fallback polling every 2s
    setInterval(()=>{ if(inp.files && inp.files.length){ handleFilesFromInput(inp); } },2000);
  });
})();
</script>
</body>
</html>
