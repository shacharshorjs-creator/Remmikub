<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0e1220">
<title>×¨××™×§×•×‘ â€“ × ×§×•×“×•×ª (v2.6-ml)</title>
<style>
  :root{--bg:#0e1220;--card:#151a2b;--ink:#eaf1ff;--muted:#9fb0c9;--line:rgba(255,255,255,.14);--accent:#63c9ff;--chip:#0b1325}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .container{width:min(980px,94vw);margin:0 auto;padding:90px 0 96px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  label{display:block;font-weight:700;margin-bottom:6px}
  input[type=text]{width:100%;background:#0b152a;color:#fff;border:2px solid var(--line);border-radius:12px;padding:12px 14px}
  button{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;background:#1c2741;color:#fff}
  .accent{background:linear-gradient(135deg,#63c9ff,#8ae9c9);color:#0b1320;font-weight:900}
  .ghost{background:transparent;border:1px dashed var(--line)}
  .danger{background:#3a1c1c;color:#ffd9d9;border:1px solid #5a2a2a}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .hidden{display:none}
  .leader{display:flex;gap:10px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid var(--line);border-radius:12px;padding:10px 12px;display:flex;gap:10px;align-items:center}
  .rank{font-weight:900;width:28px;height:28px;display:grid;place-items:center;border-radius:99px;background:#0d1a2e;border:1px solid rgba(100,200,255,.45)}
  .pill{padding:6px 10px;border-radius:999px;background:#0b172d;border:1px solid var(--line)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .numbox{width:90px;background:#0b152a;color:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px}
  .btn-upload{background:#0f1a30;border:1px solid rgba(99,201,255,.45)}
  .btn-upload::before{content:"ğŸ–¼ï¸";margin-inline-end:6px}
  .btn-plus{background:#0f2e1a;border:1px solid rgba(138,255,193,.45)}
  .btn-plus::before{content:"ğŸ“·";margin-inline-end:6px}
  .parsed{font-size:13px;color:var(--muted);margin-top:6px}
  .appbar{position:fixed;inset:0 0 auto 0;height:72px;background:rgba(8,12,24,.7);backdrop-filter:blur(10px);
          border-bottom:1px solid var(--line);z-index:10;display:flex;align-items:center}
  .appbar-inner{width:min(980px,94vw);margin:0 auto;display:flex;align-items:center;gap:12px;justify-content:space-between}
  .title{font-weight:800;letter-spacing:.2px}
  .ver{font-size:12px;padding:6px 10px;border-radius:999px;background:#0a1a2c;border:1px solid rgba(99,201,255,.4)}
  .actions{display:flex;gap:8px;align-items:center}
  .divider{height:1px;background:linear-gradient(90deg,transparent,var(--line),transparent);margin:14px 0;border:none}
  .thumbs{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .thumb{border:1px solid var(--line);border-radius:8px;padding:4px}
  .thumb span{display:block;font-size:11px;color:#c8d7ff;opacity:.9;margin-top:2px;text-align:center}
  .bbar{position:fixed;left:0;right:0;bottom:0;height:84px;background:rgba(6,10,20,.86);backdrop-filter:blur(10px);
         border-top:1px solid var(--line);display:flex;align-items:center;z-index:12}
  .bbar-inner{width:min(980px,94vw);margin:0 auto;display:flex;align-items:center;gap:12px;justify-content:space-between}
  .tilePrev{display:flex;align-items:center;gap:10px}
  .tilePrev canvas{width:64px;height:64px;border-radius:10px;border:1px solid var(--line);background:#0b152a}
</style>
</head>
<body>
<div class="appbar">
  <div class="appbar-inner">
    <div class="row">
      <div class="title">×¨××™×§×•×‘ â€“ × ×™×”×•×œ × ×§×•×“×•×ª</div>
      <div class="ver" aria-label="version">v2.6-ml</div>
    </div>
    <div class="actions">
      <div class="row">
        <label for="ignoreColor">×”×ª×¢×œ× ××¦×‘×¢</label>
        <input id="ignoreColor" type="checkbox" checked>
      </div>
      <div class="row">
        <label for="confThresh">×¡×£ ×‘×™×˜×—×•×Ÿ</label>
        <input id="confThresh" type="range" min="0.3" max="0.9" step="0.05" value="0.6">
        <span id="confVal">0.60</span>
      </div>
      <button id="resetBtn" class="danger">××™×¤×•×¡ × ×§×•×“×•×ª</button>
      <button id="clearResults" class="ghost">××™×¤×•×¡ ×ª×•×¦××•×ª</button>
      <button id="toggleTrainer" class="accent">××•×“×œ ×–×™×”×•×™ (××™××•×Ÿ)</button>
    </div>
  </div>
</div>

<div class="container">
  <section id="s1" class="card">
    <h2 style="margin-top:0">×‘×—×™×¨×ª ××©×ª×ª×¤×™× (×¢×“ 4)</h2>
    <div class="grid" style="margin-top:8px">
      <div><label for="n0">×©×—×§×Ÿ/×™×ª 1</label><input id="n0" type="text" placeholder="×œ×“×•×’××”: ×©×—×¨"></div>
      <div><label for="n1">×©×—×§×Ÿ/×™×ª 2</label><input id="n1" type="text" placeholder="×œ×“×•×’××”: ×“× ×”"></div>
      <div><label for="n2">×©×—×§×Ÿ/×™×ª 3</label><input id="n2" type="text" placeholder="××•×¤×¦×™×•× ×œ×™"></div>
      <div><label for="n3">×©×—×§×Ÿ/×™×ª 4</label><input id="n3" type="text" placeholder="××•×¤×¦×™×•× ×œ×™"></div>
    </div>
    <div class="row" style="margin-top:12px;justify-content:space-between">
      <button class="accent" id="startBtn">×”×ª×—×œ ××©×—×§</button>
      <span style="font-size:12px;color:#9fb0c9">×’×¨×¡×ª ML â€“ ××××Ÿ ××•×‘× ×” ×•×©××™×¨×” ××§×•××™×ª</span>
    </div>
  </section>

  <section id="s2" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">×œ×•×— ×”×•×‘×œ×”</h2>
      <button id="backBtn" class="ghost">â†© ×—×–×¨×” ×œ×©××•×ª</button>
    </div>
    <div id="board" class="leader" style="margin-top:10px"></div>
    <hr class="divider">
    <div id="panels" class="grid"></div>
    <div>
      <h3 style="margin:8px 0 4px">×ª×•×¦××•×ª ××—×¨×•× ×•×ª</h3>
      <div id="thumbs" class="thumbs"></div>
    </div>
  </section>

  <section id="trainer" class="card">
    <h2 style="margin-top:0">××•×“×œ ×–×™×”×•×™ â€“ ××™××•×Ÿ ×•×©××™×¨×”</h2>
    <div class="row">
      <div>
        <label>×‘×—×¨/×™ ××—×œ×§×”</label>
        <select id="cls">
          <option value="none">×œ×œ× / ×’×³×•×§×¨</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
          <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
          <option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option>
        </select>
      </div>
      <div class="row" style="gap:6px">
        <button id="addFromGallery" class="btn-upload"> ×”×•×¡×£ ××’×–×™×¨ (×¨×‘×•×ª)</button>
        <input id="filePick" type="file" accept="image/*" class="hidden" multiple>
        <button id="captureOne" class="btn-plus"> ×”×•×¡×£ ××”××¦×œ××”</button>
      </div>
      <div class="row">
        <button id="saveModel" class="ghost">×©××•×¨ ××•×“×œ</button>
        <button id="loadModel" class="ghost">×˜×¢×Ÿ ××•×“×œ</button>
        <button id="exportModel" class="ghost">×™×™×¦× JSON</button>
        <input id="importFile" type="file" accept="application/json" class="hidden">
        <button id="importModel" class="ghost">×™×™×‘× JSON</button>
        <span id="status" class="ver">××™×Ÿ ××•×“×œ</span>
      </div>
      <div class="parsed">×˜×™×¤: ×”×•×¡×£ 10â€“20 ×“×•×’×××•×ª ×œ×›×œ ××¡×¤×¨. × ×™×ª×Ÿ ×œ×”×¢×œ×•×ª ×”×¨×‘×” ×ª××•× ×•×ª ×‘×‘×ª ××—×ª.</div>
    </div>
  </section>
</div>

<div class="bbar" id="bbar">
  <div class="bbar-inner">
    <div class="tilePrev">
      <canvas id="lastTile"></canvas>
      <div>
        <div style="font-weight:700">×”×–×™×”×•×™ ×”××—×¨×•×Ÿ:</div>
        <div id="lastLabel" class="parsed">â€”</div>
      </div>
    </div>
    <div class="row">
      <button id="clearLast" class="ghost">× ×§×” ×ª×¦×•×’×”</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier@1.2.2"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script async src="https://docs.opencv.org/4.8.0/opencv.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const KEY = 'rummi_pwa_state_v2.6-ml';
  const MODEL_KEY = 'rummi_knn_v2.6-ml';
  let state = { players: [] };
  try { const raw = localStorage.getItem(KEY); if (raw) state = JSON.parse(raw); } catch(e){ console.warn(e); }

  const settings = { ignoreColor: true, conf: 0.6 };

  const $ = (s)=>document.querySelector(s);
  const statusEl = $('#status');
  const confSlider = $('#confThresh');
  const confVal = $('#confVal');
  const ignoreCb = $('#ignoreColor');

  // TF backend init (race-proof)
  let tfReady = (async()=>{ try{ await tf.ready(); if (tf.getBackend()!=='webgl') { await tf.setBackend('webgl'); await tf.ready(); } } catch(e){} })();

  function reflectUI(){ if(confSlider&&confVal){confVal.textContent = Number(confSlider.value).toFixed(2);} }
  reflectUI();
  confSlider?.addEventListener('input',(e)=>{ settings.conf = parseFloat(e.target.value); reflectUI(); });
  ignoreCb?.addEventListener('change',(e)=> settings.ignoreColor = e.target.checked );

  function save(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){ console.warn(e); } }

  const classifier = knnClassifier.create();
  let mobilenetModel=null;
  async function ensureEmbedder(){
    await tfReady;
    if(!mobilenetModel) mobilenetModel = await mobilenet.load({version:2, alpha:1.0});
    statusEl && (statusEl.textContent = 'MobileNet + KNN ××•×›×Ÿ');
  }
  ensureEmbedder();

  function toGray3(t){
    const H=t.shape[0], W=t.shape[1];
    const r=t.slice([0,0,0],[H,W,1]);
    const g=t.slice([0,0,1],[H,W,1]);
    const b=t.slice([0,0,2],[H,W,1]);
    const gray=r.mul(0.299).add(g.mul(0.587)).add(b.mul(0.114));
    return tf.concat([gray,gray,gray],2);
  }
  function preprocess(img){
    let t=tf.browser.fromPixels(img).toFloat();
    if(settings.ignoreColor) t=toGray3(t);
    t=tf.image.resizeBilinear(t,[224,224]);
    const offset=tf.scalar(127.5);
    const norm=t.sub(offset).div(offset);
    return norm.expandDims(0);
  }

  // Training lock to avoid concurrent adds
  let trainingLock = Promise.resolve();
  function withLock(fn){
    const run = trainingLock.then(fn, fn);
    trainingLock = run.catch(()=>{});
    return run;
  }

  async function addExample(imgOrCanvas,label){
    await ensureEmbedder();
    return withLock(async ()=>{
      try{
        const inp = preprocess(imgOrCanvas);
        const logits = mobilenetModel.infer(inp,'conv_preds');
        classifier.addExample(logits,label); // keep logits alive (classifier manages tensors)
        tf.dispose(inp);
        await tf.nextFrame();
      }catch(e){
        console.error('addExample error', e);
        alert('×©×’×™××ª ××™××•×Ÿ: ' + (e.message||e));
      }
    });
  }
  async function addMany(files,label){
    let ok=0, fail=0;
    for(const f of files){
      const url = URL.createObjectURL(f);
      try{
        await ensureEmbedder();
        const img = new Image(); img.src = url;
        await new Promise(res=> img.onload=res);
        await addExample(img,label);
        ok++;
      }catch(e){ fail++; console.warn('addMany fail', e); }
      finally{ URL.revokeObjectURL(url); }
      await new Promise(res=> (window.requestIdleCallback? requestIdleCallback(res,{timeout:50}) : setTimeout(res,16)));
    }
    statusEl && (statusEl.textContent = '× ×•×¡×¤×• '+ok+' ×“×•×’×××•×ª ×œ-'+label + (fail? (' (×›×©×œ×• '+fail+')') : ''));
  }

  async function predictClass(imgOrCanvas){
    await ensureEmbedder();
    if(classifier.getNumClasses()===0) return {label:'none',confidences:{none:1}};
    const inp=preprocess(imgOrCanvas);
    const logits=mobilenetModel.infer(inp,'conv_preds');
    const res=await classifier.predictClass(logits);
    tf.dispose([inp, logits]);
    return res;
  }

  function saveKNN(){
    try{
      const dataset = classifier.getClassifierDataset();
      const obj = {};
      Object.keys(dataset).forEach(k=> obj[k] = Array.from(dataset[k].dataSync()));
      const json = JSON.stringify(obj);
      localStorage.setItem(MODEL_KEY, json);
      const kb = Math.round(json.length/1024);
      alert('××•×“×œ × ×©××¨ (â‰ˆ'+kb+'KB)');
      statusEl && (statusEl.textContent = '××•×“×œ × ×©××¨');
    }catch(e){
      alert('×©××™×¨×ª ××•×“×œ × ×›×©×œ×”: ' + (e.message||e));
    }
  }
  function loadKNN(){
    try{
      const raw = localStorage.getItem(MODEL_KEY);
      if(!raw) return alert('××™×Ÿ ××•×“×œ ×©××•×¨ ×‘××›×©×™×¨');
      const obj = JSON.parse(raw);
      const tensorObj = {};
      Object.keys(obj).forEach(k=> tensorObj[k] = tf.tensor(obj[k], [obj[k].length/1001, 1001]));
      classifier.setClassifierDataset(tensorObj);
      alert('××•×“×œ × ×˜×¢×Ÿ ('+classifier.getNumClasses()+' ××—×œ×§×•×ª)');
      statusEl && (statusEl.textContent = '××•×“×œ × ×˜×¢×Ÿ');
    }catch(e){
      alert('×˜×¢×™× ×ª ××•×“×œ × ×›×©×œ×”: ' + (e.message||e));
    }
  }
  function exportKNN(){
    try{
      const dataset = classifier.getClassifierDataset();
      const obj = {};
      Object.keys(dataset).forEach(k=> obj[k] = Array.from(dataset[k].dataSync()));
      const blob = new Blob([JSON.stringify(obj)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = 'rummi_knn_v2.6-ml.json'; a.click();
    }catch(e){ alert('×™×™×¦×•× × ×›×©×œ: '+(e.message||e)); }
  }
  async function importKNN(file){
    try{
      const text = await file.text();
      const obj = JSON.parse(text);
      const tensorObj = {};
      Object.keys(obj).forEach(k=> tensorObj[k] = tf.tensor(obj[k], [obj[k].length/1001, 1001]));
      classifier.setClassifierDataset(tensorObj);
      alert('××•×“×œ ×™×•×‘× ('+classifier.getNumClasses()+' ××—×œ×§×•×ª)');
      statusEl && (statusEl.textContent = '××•×“×œ ×™×•×‘×');
    }catch(e){ alert('×™×™×‘×•× × ×›×©×œ: '+(e.message||e)); }
  }

  // OCR, segmentation, UI, game remain as in previous stable build (omitted for brevity in this patch)
  // Minimal wiring to keep flow working:
  function startGame(){
    const names=['#n0','#n1','#n2','#n3'].map(sel=>{const e=$(sel);return e?e.value.trim():'';}).filter(Boolean);
    const list=names.length?names:['×©×—×§×Ÿ 1','×©×—×§×Ÿ 2'];
    state.players=list.map((n,i)=>({id:String(i+1), name:n, points:0}));
    save(); document.getElementById('s1').classList.add('hidden'); document.getElementById('s2').classList.remove('hidden');
  }
  document.getElementById('startBtn')?.addEventListener('click', startGame);
  document.getElementById('saveModel')?.addEventListener('click', saveKNN);
  document.getElementById('loadModel')?.addEventListener('click', loadKNN);
  document.getElementById('exportModel')?.addEventListener('click', exportKNN);
  document.getElementById('importModel')?.addEventListener('click', ()=> document.getElementById('importFile').click());
  document.getElementById('importFile')?.addEventListener('change', (e)=> e.target.files[0] && importKNN(e.target.files[0]) );
  document.getElementById('addFromGallery')?.addEventListener('click', ()=>{ const picker=document.getElementById('filePick'); const cls=document.getElementById('cls').value; picker.onchange=async(e)=>{ const files=Array.from(e.target.files); await addMany(files,cls); picker.value=''; }; picker.click(); });
});
</script>
</body>
</html>
