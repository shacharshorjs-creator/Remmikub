<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>רמיקוב – משחק + אימון (v4.0-ml)</title>
<style>
  :root{--bg:#0e1726;--card:#121d2f;--ink:#d7e1ff;--muted:#8aa0c8;--acc:#5dd6c0;--danger:#c05d5d;--btn:#1b2a44}
  html,body{background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
  .wrap{max-width:960px;margin-inline:auto;padding:14px}
  .badges{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .badge{background:#122038;border:1px solid #1f3154;color:#cfe0ff;padding:6px 10px;border-radius:12px;font-size:12px}
  .section{background:var(--card);border:1px solid #203356;border-radius:14px;padding:14px;margin:12px 0}
  h2{margin:4px 0 12px 0;font-size:1.2rem}
  .playersGrid{display:grid;grid-template-columns:40px 1fr 1fr 140px;gap:10px;align-items:center}
  .pill{display:inline-block;padding:6px 10px;border-radius:10px;background:#0f1a2b;border:1px solid #223456;color:var(--muted)}
  .btn{background:var(--btn);border:1px solid #2a3e63;color:var(--ink);border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn-ok{background:#184735;border-color:#2f7a61}
  .btn-danger{background:#3a1a1a;border-color:#7b3a3a}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .grow{flex:1}
  input[type=text],input[type=number]{background:#081224;border:1px solid #243657;color:var(--ink);border-radius:8px;padding:8px}
  .thumbs{display:flex;gap:8px;overflow:auto;padding:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;background:#14233c;border:1px solid #2b446d;border-radius:999px}
  .debug{background:#0a1426;border:1px solid #223455;border-radius:12px;padding:10px;font-family:ui-monospace,SFMono-Regular,Consolas,monospace;white-space:pre-wrap;max-height:220px;overflow:auto}
  .hidden{display:none !important}
</style>
</head>
<body>
<div class="wrap">
  <div class="badges">
    <span class="badge" id="modelBadge">model: loading</span>
    <span class="badge" id="tfBadge">TF: …</span>
    <span class="badge" id="verBadge">v4.0-ml</span>
    <span class="badge small">שוחזר: <span id="restoreInfo">—</span></span>
  </div>

  <!-- בחירת משתתפים -->
  <div class="section" id="gameSetup">
    <h2>בחירת משתתפים (עד 4)</h2>
    <div class="row" style="margin-bottom:8px">
      <input id="p1" class="grow" type="text" placeholder="שחקנ/ית 1">
      <input id="p2" class="grow" type="text" placeholder="שחקנ/ית 2">
      <input id="p3" class="grow" type="text" placeholder="אופציונלי">
      <input id="p4" class="grow" type="text" placeholder="אופציונלי">
    </div>
    <div class="row">
      <button id="btnSaveNames" class="btn">שמור שמות</button>
      <button id="btnStart" class="btn btn-ok">התחל משחק</button>
      <span class="pill">ניתן לשמור שמות בלי להתחיל משחק</span>
    </div>
  </div>

  <!-- לוח הובלה יחיד -->
  <div class="section" id="scoreBoard" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>לוח הובלה</h2>
      <div class="row">
        <button id="btnBack" class="btn">חזרה לשמות</button>
        <button id="btnResetScores" class="btn btn-danger">איפוס נקודות</button>
      </div>
    </div>
    <div id="players" class="playersGrid"></div>
  </div>

  <!-- מודול אימון (כפי שהיה בבסיס – לא שינינו לוגיקה) -->
  <div class="section">
    <h2>אימון מודל זיהוי (CPU) — MobileNet + KNN</h2>
    <div class="row" style="gap:8px;margin-bottom:8px">
      <label class="chip">בחר/י מחלקה (מספר):
        <select id="classSel"></select>
      </label>
      <button class="btn" id="clearClass">נקה מחלקה</button>
      <button class="btn btn-danger" id="clearAll">נקה הכל</button>
    </div>
    <div class="row" style="gap:10px;flex-wrap:wrap">
      <label class="btn">הוסף תמונה בודדת
        <input id="pickOne" class="hidden" type="file" accept="image/*"/>
      </label>
      <label class="btn">בחר/י קבצים (גלריה)
        <input id="pickMulti" class="hidden" type="file" accept="image/*" multiple/>
      </label>
      <label class="btn">צילום מהמצלמה
        <input id="pickCam" class="hidden" type="file" accept="image/*" capture="environment"/>
      </label>
      <button class="btn" id="exportJson">ייצא JSON</button>
      <label class="btn" for="importJson">ייבא JSON<input id="importJson" type="file" accept="application/json" class="hidden"></label>
      <button class="btn" id="saveLocal">שמור מקומי</button>
      <button class="btn" id="loadLocal">טען מקומי</button>
    </div>
    <div class="thumbs" id="thumbs"></div>
    <div class="debug" id="debug">loading…</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier@1.2.2"></script>
<script>
// Helpers
const $$ = sel=>document.querySelector(sel);
const log = (s)=>{const el=$$('#debug'); el.textContent += (el.textContent? '\\n' : '') + s; el.scrollTop = el.scrollHeight;};

// ===== players & board =====
const nameIds = ['p1','p2','p3','p4'];
let players = []; // {name, score}
const LS_STATE = 'rummi_state_v40';
function sanitizeName(val, idx){ const s=(val||'').trim(); return s ? s : `שחקנ/ית ${idx+1}`; }
function readNames(){ return nameIds.map((id,i)=>sanitizeName(document.getElementById(id)?.value, i)); }
function saveState(){ try{ localStorage.setItem(LS_STATE, JSON.stringify({players})); }catch(e){} }
(function restore(){
  try{
    const raw = localStorage.getItem(LS_STATE);
    if(raw){
      const state = JSON.parse(raw);
      if (Array.isArray(state.players)) {
        players = state.players.map(p=>({name:String(p.name||''), score:Number(p.score||0)}));
        // Fill inputs with saved names
        players.forEach((p,i)=>{ if ($$('#'+nameIds[i])) $$('#'+nameIds[i]).value = p.name; });
        renderBoard(); $$('#scoreBoard').style.display='block';
      }
    }
  }catch{}
})();
function applyNames(){
  const names = readNames();
  if (!Array.isArray(players) || players.length===0){
    players = names.filter(n=>n).map(n=>({name:n, score:0}));
  }else{
    players.forEach((p,i)=>{ if (names[i]) p.name = names[i]; });
  }
  renderBoard(); saveState();
}
function startGame(){
  applyNames();
  $$('#gameSetup').style.display='none';
  $$('#scoreBoard').style.display='block';
}
function changeScore(i, delta){
  if(!players[i]) return;
  players[i].score = Number(players[i].score||0) + Number(delta||0);
  saveState(); renderBoard();
}
function renderBoard(){
  const host = $$('#players'); host.innerHTML='';
  players.forEach((p,idx)=>{
    const idxEl = document.createElement('div'); idxEl.className='pill'; idxEl.textContent=String(idx+1);
    const nameEl= document.createElement('div'); nameEl.textContent=p.name;
    const scoreEl=document.createElement('div'); scoreEl.className='pill'; scoreEl.textContent='נקודות: '+p.score;
    const controls=document.createElement('div'); controls.className='row';
    const plus = document.createElement('button'); plus.className='btn'; plus.textContent='+10'; plus.onclick=()=>changeScore(idx,10);
    const minus= document.createElement('button'); minus.className='btn btn-danger'; minus.textContent='-10'; minus.onclick=()=>changeScore(idx,-10);
    const inp  = document.createElement('input'); inp.type='number'; inp.placeholder='ערך';
    const add  = document.createElement('button'); add.className='btn btn-ok'; add.textContent='הוסף'; add.onclick=()=>{ const v=Number(inp.value||0); if(!isNaN(v)&&v){ changeScore(idx,v); inp.value=''; } };
    controls.append(plus,minus,inp,add);
    host.append(idxEl,nameEl,scoreEl,controls);
  });
}
// wire UI
$$('#btnSaveNames').onclick = (e)=>{ e.preventDefault(); applyNames(); $$('#scoreBoard').style.display='block'; };
$$('#btnStart').onclick = (e)=>{ e.preventDefault(); startGame(); };
$$('#btnBack').onclick = ()=>{ $$('#gameSetup').style.display='block'; $$('#scoreBoard').style.display='none'; };
$$('#btnResetScores').onclick = ()=>{ players.forEach(p=>p.score=0); saveState(); renderBoard(); };

// ===== TF + trainer (unchanged logic) =====
let net=null, classifier=null; let ready=false;
const classSel = $$('#classSel');
for(let i=1;i<=13;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=i; classSel.appendChild(o); }

(async function initTF(){
  try{
    await tf.setBackend('cpu');
    await tf.ready();
    $$('#tfBadge').textContent = 'TF: '+tf.getBackend();
    classifier = knnClassifier.create();
    net = await mobilenet.load({version:2, alpha:1.0});
    ready = true;
    $$('#modelBadge').textContent = 'model: ready';
    log('backend: '+tf.getBackend());
    log('models loaded');
    tryRestoreLocal();
  }catch(err){
    $$('#modelBadge').textContent = 'model: error';
    log('ERROR init: '+(err?.message||err));
  }
})();

function addThumb(img, label){
  const c = document.createElement('div'); c.className='chip'; c.innerHTML = `<span>${label}</span>`;
  c.appendChild(img);
  $$('#thumbs').appendChild(c);
}
async function fileToImage(file){
  return new Promise((res,rej)=>{
    const img = new Image();
    img.onload = ()=>res(img);
    img.onerror = rej;
    const fr = new FileReader();
    fr.onload = ()=>{ img.src = fr.result; };
    fr.readAsDataURL(file);
  });
}
function imageToTensor(img){
  const canvas = document.createElement('canvas');
  const s=224; canvas.width=s; canvas.height=s;
  const ctx=canvas.getContext('2d');
  const ratio = Math.min(s/img.width, s/img.height);
  const w = img.width*ratio, h=img.height*ratio;
  ctx.fillStyle='#000'; ctx.fillRect(0,0,s,s);
  ctx.drawImage(img, (s-w)/2,(s-h)/2,w,h);
  return tf.browser.fromPixels(canvas);
}
async function addExampleFromFile(file,label){
  if(!ready){ log('ERR addExample models not ready'); return; }
  try{
    const img = await fileToImage(file);
    const input = imageToTensor(img);
    const embedding = net.infer(input, 'conv_preds');
    classifier.addExample(embedding, String(label));
    addThumb(img,label);
    tf.dispose([input]);
  }catch(e){ log('ERR addExample '+(e?.message||e)); }
}
// handlers (trainer)
$$('#pickOne').onchange = async (e)=>{ const f=e.target.files?.[0]; if(!f) return; await addExampleFromFile(f, classSel.value); e.target.value=''; updateSaveInfo(); };
$$('#pickMulti').onchange = async (e)=>{ const files=Array.from(e.target.files||[]); for(const f of files){ await addExampleFromFile(f, classSel.value); } e.target.value=''; updateSaveInfo(); };
$$('#pickCam').onchange = async (e)=>{ const f=e.target.files?.[0]; if(!f) return; await addExampleFromFile(f, classSel.value); e.target.value=''; updateSaveInfo(); };
$$('#clearAll').onclick = ()=>{ if(!classifier) return; classifier.clearAllClasses(); $$('#thumbs').innerHTML=''; updateSaveInfo(); };
$$('#clearClass').onclick = ()=>{ if(!classifier) return; classifier.clearClass(classSel.value); updateSaveInfo(); };

// Save / Load same as baseline
function datasetToJSON(){
  const ds = classifier.getClassifierDataset();
  const json = {};
  Object.keys(ds).forEach(label=>{
    const t = ds[label];
    json[label] = Array.from(t.dataSync());
    json[label+'_shape'] = t.shape;
  });
  return json;
}
function jsonToDataset(json){
  const ds = {};
  Object.keys(json).forEach(k=>{
    if(k.endsWith('_shape')) return;
    const shape = json[k+'_shape'];
    ds[k] = tf.tensor(json[k], shape);
  });
  classifier.setClassifierDataset(ds);
}
function updateSaveInfo(extra=''){
  const ds = classifier.getClassifierDataset();
  let vec=0; Object.values(ds).forEach(t=> vec += t.shape[0]);
  const json = datasetToJSON();
  const bytes = new Blob([JSON.stringify(json)]).size;
  $$('#restoreInfo').textContent = `${(bytes/1024).toFixed(1)} KB • vectors:${vec}`;
  $$('#modelBadge').textContent = 'model: ready';
}
$$('#exportJson').onclick = ()=>{
  const json = datasetToJSON();
  const blob = new Blob([JSON.stringify(json)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'rummikub_knn_model.json';
  a.click();
  localStorage.setItem('rk_knn_v1', JSON.stringify(json));
  updateSaveInfo('saved');
};
$$('#importJson').onchange = async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const txt = await f.text();
  try{
    const json = JSON.parse(txt);
    jsonToDataset(json);
    localStorage.setItem('rk_knn_v1', txt);
    updateSaveInfo('imported');
  }catch(err){ alert('JSON לא תקין'); }
  e.target.value='';
};
$$('#saveLocal').onclick = ()=>{
  const json = JSON.stringify(datasetToJSON());
  localStorage.setItem('rk_knn_v1', json);
  updateSaveInfo('saved');
};
$$('#loadLocal').onclick = tryRestoreLocal;
function tryRestoreLocal(){
  const txt = localStorage.getItem('rk_knn_v1');
  if(!txt){ $$('#restoreInfo').textContent = '—'; return; }
  try{
    const json = JSON.parse(txt);
    jsonToDataset(json);
    updateSaveInfo('restored');
  }catch(err){
    $$('#restoreInfo').textContent = 'failed';
  }
}
</script>
</body>
</html>
