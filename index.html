<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0e1220">
<title>×¨××™×§×•×‘ â€“ × ×§×•×“×•×ª (OpenCV + Tesseract â€“ ××ª×•×§×Ÿ)</title>
<style>
  :root{--card:#171a2a;--ink:#ecf2ff;--muted:#9fb0c9;--accent:#63c9ff;--accent2:#8affc1}
  body{margin:0;background:#0e1220;color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{width:min(900px,94vw);margin:0 auto;padding:18px 0 28px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  label{display:block;font-weight:700;margin-bottom:6px}
  input[type=text]{width:100%;background:#0b152a;color:#fff;border:2px solid rgba(255,255,255,.35);border-radius:12px;padding:12px 14px}
  button{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;background:#1c2741;color:#fff}
  .accent{background:linear-gradient(135deg,#63c9ff,#8affc1);color:#0b1320;font-weight:900}
  .ghost{background:transparent;border:1px dashed rgba(255,255,255,.35)}
  .danger{background:#3a1c1c;color:#ffd9d9;border:1px solid #5a2a2a}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(230px,1fr))}
  .hidden{display:none}
  .leader{display:flex;gap:10px;flex-wrap:wrap}
  .chip{background:#0b1325;border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:10px 12px;display:flex;gap:10px;align-items:center}
  .rank{font-weight:900;width:28px;height:28px;display:grid;place-items:center;border-radius:99px;background:#0d1a2e;border:1px solid rgba(100,200,255,.45)}
  .pill{padding:6px 10px;border-radius:999px;background:#0b172d;border:1px solid rgba(255,255,255,.18)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .numbox{width:90px;background:#0b152a;color:#fff;border:1px solid rgba(255,255,255,.25);border-radius:10px;padding:8px 10px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .cam{background:#0f1a30;border:1px solid rgba(99,201,255,.45)}
  .cam::before{content:"ğŸ“·";margin-inline-end:6px}
  .help{font-size:12px;opacity:.8;margin-top:6px}
  .note{font-size:12px;color:#9fb0c9}
</style>
</head>
<body>
<div class="wrap">
  <header class="row">
    <div>×¨××™×§×•×‘ â€“ PWA (OpenCV + Tesseract)</div>
    <div class="row">
      <button id="resetBtn" class="danger">××™×¤×•×¡ × ×§×•×“×•×ª</button>
    </div>
  </header>

  <section id="s1" class="card">
    <h2>×‘×—×™×¨×ª ××©×ª×ª×¤×™× (×¢×“ 4)</h2>
    <div class="grid" style="margin-top:8px">
      <div><label for="n0">×©×—×§×Ÿ/×™×ª 1</label><input id="n0" type="text" placeholder="×œ×“×•×’××”: ×©×—×¨"></div>
      <div><label for="n1">×©×—×§×Ÿ/×™×ª 2</label><input id="n1" type="text" placeholder="×œ×“×•×’××”: ×“× ×”"></div>
      <div><label for="n2">×©×—×§×Ÿ/×™×ª 3</label><input id="n2" type="text" placeholder="××•×¤×¦×™×•× ×œ×™"></div>
      <div><label for="n3">×©×—×§×Ÿ/×™×ª 4</label><input id="n3" type="text" placeholder="××•×¤×¦×™×•× ×œ×™"></div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="accent" id="startBtn">×”×ª×—×œ ××©×—×§</button>
      <div class="note">×”××œ×’×•×¨×™×ª× ×××ª×¨ ××ª ×”×¡×¤×¨×•×ª ×”×’×“×•×œ×•×ª ×‘×¢×–×¨×ª ×¡×’×× ×˜×¦×™×” ×©×œ OpenCV ×•××– ××¤×¢×™×œ OCR × ×§×•×“×ª×™ ×¢×œ×™×”×Ÿ.</div>
    </div>
  </section>

  <section id="s2" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">×œ×•×— ×”×•×‘×œ×”</h2>
      <button id="backBtn" class="ghost">â†© ×—×–×¨×” ×œ×©××•×ª</button>
    </div>
    <div id="board" class="leader" style="margin-top:10px"></div>
    <hr style="border:none;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);margin:14px 0">
    <div id="panels" class="grid"></div>
  </section>
</div>

<!-- OpenCV & Tesseract -->
<script async src="https://docs.opencv.org/4.8.0/opencv.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
  const KEY = 'rummi_pwa_state_cv_v2';
  let state = { players: [] };
  try { const raw = localStorage.getItem(KEY); if (raw) state = JSON.parse(raw); } catch {}

  const $ = s => document.querySelector(s);
  function save(){ try { localStorage.setItem(KEY, JSON.stringify(state)); } catch {} }
  function val(id){ const e=$(id); return e? e.value.trim() : ""; }

  function startGame(){
    const names = ['#n0','#n1','#n2','#n3'].map(val).filter(Boolean);
    const list = names.length ? names : ['×©×—×§×Ÿ 1','×©×—×§×Ÿ 2'];
    state.players = list.map((n,i)=>({id:String(i+1), name:n, points:0}));
    save(); showGame();
  }
  function showGame(){ $('#s1').classList.add('hidden'); $('#s2').classList.remove('hidden'); render(); window.scrollTo({top:0,behavior:'smooth'}); }
  function backToNames(){ $('#s2').classList.add('hidden'); $('#s1').classList.remove('hidden'); }
  function addPoints(id,delta){ const p=state.players.find(x=>x.id===id); if(!p) return; p.points += delta; save(); render(); }
  function setPoints(id,val){ const p=state.players.find(x=>x.id===id); if(!p) return; p.points = val; save(); render(); }

  function ensureCvReady(){
    return new Promise((resolve,reject)=>{
      if (typeof cv !== 'undefined' && cv.Mat) return resolve();
      const t = setInterval(()=>{
        if (typeof cv !== 'undefined' && cv.Mat){ clearInterval(t); resolve(); }
      }, 50);
      setTimeout(()=>{ clearInterval(t); reject(new Error('OpenCV ×œ× × ×˜×¢×Ÿ')); }, 7000);
    });
  }

  async function segmentDigits(file){
    await ensureCvReady();
    const img = await createImageBitmap(file);
    const scale = Math.min(1280/img.width, 1280/img.height, 1);
    const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
    const cvs = document.createElement('canvas'); cvs.width=w; cvs.height=h;
    const ctx = cvs.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);

    let src = cv.imread(cvs);
    let gray = new cv.Mat(); cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
    let blur = new cv.Mat(); cv.GaussianBlur(gray, blur, new cv.Size(5,5), 0);
    let bin = new cv.Mat(); cv.threshold(blur, bin, 0, 255, cv.THRESH_BINARY_INV + cv.THRESH_OTSU);

    let kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(3,3));
    cv.morphologyEx(bin, bin, cv.MORPH_OPEN, kernel);
    cv.morphologyEx(bin, bin, cv.MORPH_CLOSE, kernel);

    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();
    cv.findContours(bin, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    const candidates = [];
    for (let i = 0; i < contours.size(); i++) {
      const cnt = contours.get(i);
      const rect = cv.boundingRect(cnt);
      const area = rect.width * rect.height;
      const relA = area / (w*h);
      const relH = rect.height / h;
      const ar = rect.width / rect.height;
      if (relA > 0.02 && relH > 0.25 && ar < 1.2) {
        candidates.push(rect);
      }
      cnt.delete();
    }
    contours.delete(); hierarchy.delete(); kernel.delete(); src.delete(); gray.delete(); blur.delete(); bin.delete();

    candidates.sort((a,b)=> a.x - b.x);

    const crops = candidates.map(r => {
      const pad = Math.round(Math.max(w,h)*0.02);
      const x = Math.max(0, r.x - pad), y = Math.max(0, r.y - pad);
      const cw = Math.min(w - x, r.width + pad*2), ch = Math.min(h - y, r.height + pad*2);
      const c = document.createElement('canvas'); c.width=cw; c.height=ch;
      const cctx = c.getContext('2d'); cctx.drawImage(cvs, x, y, cw, ch, 0, 0, cw, ch);
      return {canvas:c, rect:r};
    });
    return crops;
  }

  async function ocrDigitCanvas(c){
    const { data } = await Tesseract.recognize(c, 'eng', { config: 'tessedit_char_whitelist=0123456789 --psm 10' });
    let txt = (data && data.text || '').trim();
    if (!txt) {
      const { data: d2 } = await Tesseract.recognize(c, 'eng', { config: 'tessedit_char_whitelist=0123456789 --psm 7' });
      txt = (d2 && d2.text || '').trim();
    }
    const m = txt.match(/[0-9]/);
    return m ? m[0] : '';
  }

  function combine1013(digits, rects){
    const out = [];
    for (let i=0;i<digits.length;i++){
      const d = digits[i];
      if (d==='1' && i+1<digits.length && ['0','1','2','3'].includes(digits[i+1])) {
        const r1 = rects[i], r2 = rects[i+1];
        const sameLine = Math.abs(r1.y - r2.y) < Math.max(r1.height, r2.height)*0.3;
        const near = (r2.x - (r1.x + r1.width)) < Math.max(r1.height, r2.height)*0.6;
        if (sameLine && near) {
          out.push(10 + parseInt(digits[i+1],10));
          i++; continue;
        }
      }
      out.push(parseInt(d,10));
    }
    return out.filter(n => n>=1 && n<=13);
  }

  async function detectNumbers(file){
    const crops = await segmentDigits(file);
    if (!crops.length) return [];
    const digits = [];
    for (const {canvas} of crops) {
      digits.push(await ocrDigitCanvas(canvas));
    }
    const clean = digits.map(d => d || '').filter(Boolean);
    const nums = combine1013(clean, crops.map(c => c.rect));
    return nums;
  }

  async function handleCamera(id, file, mount){
    mount.textContent = '×××ª×¨ ×¡×¤×¨×•×ªâ€¦';
    try{
      const nums = await detectNumbers(file);
      if(!nums.length){ mount.textContent='×œ× ×–×•×”×ª×” ×¡×¤×¨×”. × ×¡×• ×œ×¦×œ× ×§×¨×•×‘ ×™×•×ª×¨, ×¤×¨×™×™× × ×§×™ ×•×¨×§×¢ ×—×œ×§.'; return; }
      const s = nums.reduce((a,b)=>a+b,0);
      mount.textContent = '×–×•×”×”: ' + nums.join(' + ') + ' = ' + s;
      setPoints(id, s);
    }catch(e){
      mount.textContent = '×©×’×™××”: ' + e.message;
    }
  }

  function render(){
    const board = document.getElementById('board'); board.innerHTML = '';
    const sorted = state.players.slice().sort((a,b)=> b.points-a.points);
    sorted.forEach((p,i)=>{
      const div = document.createElement('div'); div.className='chip';
      div.innerHTML = '<div class="rank">'+(i+1)+'</div><div>'+p.name+(i===0?' ğŸ‘‘':'')+'</div><div style="margin-inline-start:auto">'+p.points+' × ×§×³</div>';
      board.appendChild(div);
    });

    const panels = document.getElementById('panels'); panels.innerHTML='';
    state.players.forEach(p=>{
      const card = document.createElement('div'); card.className='card';
      const head = document.createElement('div'); head.className='row';
      const title = document.createElement('h3'); title.style.margin='0'; title.textContent = p.name;
      const mount = document.createElement('div'); mount.className='help'; mount.textContent='×œ×—×¥/×™ ×¦×™×œ×•× ×œ×–×™×”×•×™ ××•×˜×•××˜×™.';
      const fileIn = document.createElement('input'); fileIn.type='file'; fileIn.accept='image/*'; fileIn.capture='environment'; fileIn.className='hidden';
      const camBtn = document.createElement('button'); camBtn.className='cam'; camBtn.textContent=' ×¦×™×œ×•×';
      camBtn.onclick=()=> fileIn.click();
      fileIn.onchange=(e)=>{ const f=e.target.files[0]; if(f) handleCamera(p.id,f,mount); e.target.value=''; };
      head.appendChild(title); head.appendChild(camBtn);
      card.appendChild(head); card.appendChild(fileIn);

      const meta = document.createElement('div'); meta.innerHTML = '× ×§×•×“×•×ª × ×•×›×—×™×•×ª: <span class="pill">'+p.points+'</span>';
      card.appendChild(meta);

      const ctrls = document.createElement('div'); ctrls.className='controls';
      const num = document.createElement('input'); num.type='number'; num.className='numbox'; num.placeholder='+/-';
      const go  = document.createElement('button'); go.textContent='×”×•×¡×£/×”×¤×—×ª'; go.onclick=()=>{ const d=Number(num.value); if(!Number.isNaN(d)&&num.value!==''){ addPoints(p.id,d); num.value=''; } };
      ctrls.appendChild(num); ctrls.appendChild(go);
      const minus10 = document.createElement('button'); minus10.textContent='-10'; minus10.onclick=()=>addPoints(p.id,-10); ctrls.appendChild(minus10);
      card.appendChild(ctrls); /* fixed here */
      card.appendChild(mount);

      panels.appendChild(card);
    });
  }

  document.getElementById('startBtn').addEventListener('click', startGame);
  document.getElementById('backBtn').addEventListener('click', backToNames);
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    if(confirm('×œ××¤×¡ ××ª ×›×œ ×”× ×§×•×“×•×ª?')){ state.players.forEach(p=>p.points=0); save(); render(); }
  });
  if(state.players && state.players.length){ showGame(); }
</script>
</body>
</html>