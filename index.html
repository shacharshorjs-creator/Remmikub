<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>×¨××™×§×•×‘ â€“ ××¦×‘ ××©×—×§ (v2.16-ml)</title>
<meta name="theme-color" content="#0e1220">
<style>
  :root{--bg:#0e1220;--card:#151a2b;--ink:#eaf1ff;--muted:#9fb0c9;--line:rgba(255,255,255,.14);--chip:#0b1325;--accent:#63c9ff;--accent2:#8ae9c9;--good:#19d19b;--warn:#ffd166}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .container{width:min(980px,94vw);margin:0 auto;padding:112px 0 112px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  input[type=text],input[type=number]{background:#0b152a;color:#fff;border:1px solid var(--line);border-radius:12px;padding:10px 12px}
  button{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;background:#1c2741;color:#fff}
  .accent{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0b1320;font-weight:800}
  .ghost{background:transparent;border:1px dashed var(--line)}
  .danger{background:#3a1c1c;color:#ffd9d9;border:1px solid #5a2a2a}
  .leader{display:flex;gap:10px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid var(--line);border-radius:12px;padding:10px 12px;display:flex;gap:10px;align-items:center}
  .rank{font-weight:900;width:28px;height:28px;display:grid;place-items:center;border-radius:50%;background:#0d1a2e;border:1px solid rgba(100,200,255,.45)}
  .pill{padding:6px 10px;border-radius:999px;background:#0b172d;border:1px solid var(--line)}
  .thumbs{display:flex;flex-wrap:wrap;gap:6px}
  .thumb{border:1px solid var(--line);border-radius:8px;padding:4px}
  .thumb span{display:block;font-size:11px;color:#c8d7ff;opacity:.9;margin-top:2px;text-align:center}
  .hidden{display:none}
  .appbar{position:fixed;inset:0 0 auto 0;height:90px;background:rgba(8,12,24,.82);backdrop-filter:blur(12px);border-bottom:1px solid var(--line);z-index:10;display:flex;align-items:center}
  .appbar-inner{width:min(980px,94vw);margin:0 auto;display:flex;align-items:center;gap:12px;justify-content:space-between}
  .title{font-weight:800;letter-spacing:.2px}
  .ver{font-size:12px;padding:6px 10px;border-radius:999px;background:#0a1a2c;border:1px solid rgba(99,201,255,.4)}
  .badge{font-size:12px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#0a1628}
  .big-toggle{display:flex;align-items:center;gap:12px;background:#0a1426;border:2px solid var(--line);border-radius:14px;padding:10px 14px}
  .big-toggle.active{border-color:rgba(25,209,155,.6);box-shadow:0 0 0 3px rgba(25,209,155,.15) inset}
  .big-toggle .state{font-weight:800}
  .slider-wrap{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;background:#0a1426;padding:8px 12px}
  input[type=range]{width:160px}
  .divider{height:1px;background:linear-gradient(90deg,transparent,var(--line),transparent);margin:14px 0;border:none}
  .bbar{position:fixed;left:0;right:0;bottom:0;height:96px;background:rgba(6,10,20,.9);backdrop-filter:blur(10px);border-top:1px solid var(--line);display:flex;align-items:center;z-index:12}
  .bbar-inner{width:min(980px,94vw);margin:0 auto;display:flex;align-items:center;gap:12px;justify-content:space-between}
  .tilePrev{display:flex;align-items:center;gap:10px}
  .tilePrev canvas{width:64px;height:64px;border-radius:10px;border:1px solid var(--line);background:#0b152a}
  .mini{font-size:12px;color:#9fb0c9}
</style>
</head>
<body>
<div class="appbar">
  <div class="appbar-inner">
    <div class="row">
      <div class="title">×¨××™×§×•×‘ â€“ ××¦×‘ ××©×—×§</div>
      <div class="ver">v2.16-ml</div>
      <span id="backendBadge" class="badge">TF: â€”</span>
    </div>
    <div class="row">
      <button id="ignoreBtn" class="big-toggle active" title="×”××¨×” ×œ×©×—×•×¨-×œ×‘×Ÿ â€” ×¢×•×–×¨ ×œ×”×ª×¢×œ× ××¦×‘×¢×™ ×”×§×•×‘×™×™×”">
        <span>ğŸ¨ ×”×ª×¢×œ× ××¦×‘×¢</span>
        <span class="state" id="ignoreLbl">×¤×¢×™×œ</span>
      </button>
      <div class="slider-wrap" title="×“×¨×™×©×ª ×‘×™×˜×—×•×Ÿ ××–×™×”×•×™ ML">
        <label for="confThresh">×¡×£ ×‘×™×˜×—×•×Ÿ</label>
        <input id="confThresh" type="range" min="0.3" max="0.95" step="0.05" value="0.65">
        <span id="confVal">0.65</span>
      </div>
      <button id="resetBtn" class="danger">××™×¤×•×¡ × ×§×•×“×•×ª</button>
      <button id="clearResults" class="ghost">××™×¤×•×¡ ×ª×•×¦××•×ª</button>
      <button id="toggleTrainer" class="accent">××™××•×Ÿ ××•×“×œ</button>
    </div>
  </div>
</div>

<div class="container">
  <section id="s1" class="card">
    <h2 style="margin:0">×‘×—×™×¨×ª ××©×ª×ª×¤×™× (×¢×“ 4)</h2>
    <div class="grid" style="margin-top:8px">
      <div><label for="n0">×©×—×§×Ÿ/×™×ª 1</label><input id="n0" type="text" placeholder="×œ×“×•×’××”: ×©×—×¨"></div>
      <div><label for="n1">×©×—×§×Ÿ/×™×ª 2</label><input id="n1" type="text" placeholder="×œ×“×•×’××”: ×“× ×”"></div>
      <div><label for="n2">×©×—×§×Ÿ/×™×ª 3</label><input id="n2" type="text" placeholder="××•×¤×¦×™×•× ×œ×™"></div>
      <div><label for="n3">×©×—×§×Ÿ/×™×ª 4</label><input id="n3" type="text" placeholder="××•×¤×¦×™×•× ×œ×™"></div>
    </div>
    <div class="row" style="margin-top:12px;justify-content:space-between">
      <button class="accent" id="startBtn">×”×ª×—×œ ××©×—×§</button>
      <span class="mini">××¦×‘ ××©×—×§ + ××™××•×Ÿ</span>
    </div>
  </section>

  <section id="s2" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">×œ×•×— ×”×•×‘×œ×”</h2>
      <button id="backBtn" class="ghost">â†© ×—×–×¨×” ×œ×©××•×ª</button>
    </div>
    <div id="board" class="leader" style="margin-top:10px"></div>
    <hr class="divider">
    <div id="panels" class="grid"></div>
    <div>
      <h3 style="margin:8px 0 4px">×ª×•×¦××•×ª ××—×¨×•× ×•×ª</h3>
      <div id="thumbs" class="thumbs"></div>
    </div>
  </section>

  <section id="trainer" class="card hidden">
    <h2 style="margin-top:0">××™××•×Ÿ ××•×“×œ ×–×™×”×•×™ (×¢×œ ×”××›×©×™×¨)</h2>
    <div class="row">
      <div>
        <label>×‘×—×¨/×™ ××—×œ×§×”</label>
        <select id="cls">
          <option value="none">×œ×œ× / ×’×³×•×§×¨</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
          <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
          <option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option>
        </select>
      </div>
      <div class="row" style="gap:6px">
        <button id="addFromGallery" class="btn-upload"> ×”×•×¡×£ ××’×–×™×¨ (×¢×“ 20)</button>
        <input id="filePick" type="file" accept="image/*" class="hidden" multiple>
        <button id="captureOne" class="btn-plus"> ×”×•×¡×£ ××”××¦×œ××”</button>
      </div>
      <div class="row">
        <button id="saveModel" class="ghost">×©××•×¨ ××•×“×œ</button>
        <button id="loadModel" class="ghost">×˜×¢×Ÿ ××•×“×œ</button>
        <button id="exportModel" class="ghost">×™×™×¦× JSON</button>
        <input id="importFile" type="file" accept="application/json" class="hidden">
        <button id="importModel" class="ghost">×™×™×‘× JSON</button>
        <span id="status" class="ver">××™×Ÿ ××•×“×œ</span>
      </div>
      <div class="row mini">×˜×™×¤: ×”×•×¡×£ 10â€“20 ×“×•×’×××•×ª ×œ×›×œ ××¡×¤×¨</div>
      <div class="row mini" id="countsRow">×“×•×’×××•×ª ×œ××¡×¤×¨×™×: (×˜×¨× ××™××•×Ÿ)</div>
    </div>
  </section>
</div>

<div class="bbar">
  <div class="bbar-inner">
    <div class="tilePrev">
      <canvas id="lastTile" width="64" height="64"></canvas>
      <div>
        <div style="font-weight:700">×”×–×™×”×•×™ ×”××—×¨×•×Ÿ:</div>
        <div id="lastLabel" class="mini">â€”</div>
        <div id="preprocBadge" class="mini">×§×“×-×¢×™×‘×•×“: ×¦×‘×¢</div>
      </div>
    </div>
    <div class="row">
      <button id="clearLast" class="ghost">× ×§×” ×ª×¦×•×’×”</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier@1.2.2"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script async src="https://docs.opencv.org/4.8.0/opencv.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async function(){
  const KEY = 'rummi_game_state_v2.16-ml';
  const MODEL_KEY = 'rummi_knn_v2.16-ml';
  let state = { players: [] };
  try { const raw = localStorage.getItem(KEY); if (raw) state = JSON.parse(raw); } catch(e) { console.warn(e); }

  // Backend badge
  try { await tf.setBackend('webgl'); await tf.ready(); } catch(e) { await tf.setBackend('cpu'); }
  finally { const b=document.getElementById('backendBadge'); if(b) b.textContent='TF: '+tf.getBackend(); }

  const settings = { ignoreColor: true, conf: 0.65 };
  const confSlider = document.getElementById('confThresh'); const confVal = document.getElementById('confVal');
  const preprocBadge = document.getElementById('preprocBadge');
  function reflectUI() { confVal.textContent = Number(confSlider.value).toFixed(2); preprocBadge.textContent = '×§×“×-×¢×™×‘×•×“: ' + (settings.ignoreColor ? '×©×—×•×¨-×œ×‘×Ÿ' : '×¦×‘×¢'); }
  reflectUI();

  // Persist settings
  try { const sraw=localStorage.getItem(KEY+'_settings'); if(sraw) { const s=JSON.parse(sraw); if(typeof s.ignoreColor==='boolean') settings.ignoreColor=s.ignoreColor; if(typeof s.conf==='number') { settings.conf=s.conf; confSlider.value=String(s.conf); } } } catch(e) {}
  function persistSettings(){ try{ localStorage.setItem(KEY+'_settings', JSON.stringify(settings)); }catch(e){} }

  // Ignore color button
  const ignoreBtn = document.getElementById('ignoreBtn'); const ignoreLbl = document.getElementById('ignoreLbl');
  function setIgnoreUI(){ ignoreLbl.textContent = settings.ignoreColor ? '×¤×¢×™×œ' : '×›×‘×•×™'; ignoreBtn.classList.toggle('active', settings.ignoreColor); reflectUI(); }
  setIgnoreUI();
  ignoreBtn.addEventListener('click', function(){ settings.ignoreColor=!settings.ignoreColor; setIgnoreUI(); persistSettings(); });
  confSlider.addEventListener('input', function(e){ settings.conf=parseFloat(e.target.value); reflectUI(); persistSettings(); });

  function save(){ try { localStorage.setItem(KEY, JSON.stringify(state)); } catch(e) { console.warn(e); } }

  // ===== TF + KNN =====
  const classifier = knnClassifier.create();
  let mobilenetModel = null;
  let EMB = 1001; // default
  let tfReady = (async()=>{ try{ await tf.ready(); }catch(e){} })();
  async function ensureEmbedder(){
    await tfReady;
    if(!mobilenetModel) mobilenetModel = await mobilenet.load({version:2, alpha:0.35});
    // try to infer embedding size
    try {
      const dummy = tf.zeros([1,224,224,3]);
      const out = mobilenetModel.infer(dummy, 'conv_preds');
      EMB = out.shape[out.shape.length-1] || 1001;
      out.dispose(); dummy.dispose();
    } catch(_){ EMB = 1001; }
    const el=document.getElementById('status'); if(el) el.textContent='MobileNet(0.35) + KNN ××•×›×Ÿ Â· emb='+EMB;
  }
  ensureEmbedder();

  function toGray3(t){
    const H=t.shape[0], W=t.shape[1];
    const r=t.slice([0,0,0],[H,W,1]);
    const g=t.slice([0,0,1],[H,W,1]);
    const b=t.slice([0,0,2],[H,W,1]);
    const gray=r.mul(0.299).add(g.mul(0.587)).add(b.mul(0.114));
    return tf.concat([gray,gray,gray],2);
  }
  function preprocess(img){
    return tf.tidy(()=>{
      let t=tf.browser.fromPixels(img).toFloat();
      if(settings.ignoreColor) t=toGray3(t);
      t=tf.image.resizeBilinear(t,[224,224]);
      const o=tf.scalar(127.5);
      return t.sub(o).div(o).expandDims(0);
    });
  }
  function embed(img){
    return tf.tidy(()=>{
      const inp=preprocess(img);
      const emb=mobilenetModel.infer(inp,'conv_preds');
      return tf.keep(emb.as2D(1, emb.shape[1]));
    });
  }
  async function addExample(img,label){
    if(!label || label==='none'){ const st=document.getElementById('status'); if(st) st.textContent='×‘×—×¨/×™ ××—×œ×§×” ×œ×¤× ×™ ××™××•×Ÿ'; return; }
    const logits=embed(img);
    classifier.addExample(logits,label);
    logits.dispose(); // important to avoid leak
    await tf.nextFrame(); refreshCounts();
  }

  // sequential loader with reuse
  async function addMany(files,label){
    if(!label || label==='none'){ const st=document.getElementById('status'); if(st) st.textContent='×‘×—×¨/×™ ××—×œ×§×” ×œ×¤× ×™ ××™××•×Ÿ'; return; }
    const list=Array.from(files).slice(0,20);
    let ok=0, fail=0; const status=document.getElementById('status');
    const img = new Image();
    for(let i=0;i<list.length;i++){
      const f=list[i];
      const url=URL.createObjectURL(f);
      try{
        // load
        await new Promise((resolve,reject)=>{ img.onload=resolve; img.onerror=reject; img.src=url; });
        await addExample(img,label); ok++;
        if(status) status.textContent='××××Ÿ: '+(i+1)+'/'+list.length;
      }catch(e){ fail++; }
      finally{ URL.revokeObjectURL(url); }
      await tf.nextFrame();
      await new Promise(r=> (window.requestIdleCallback ? requestIdleCallback(()=>r(),{timeout:60}) : setTimeout(r,30)));
    }
    if(status) status.textContent='× ×•×¡×¤×• '+ok+' ×“×•×’×××•×ª ×œ-'+label+(fail?(' (×›×©×œ×• '+fail+')'):''); refreshCounts();
  }

  async function predictClass(img){
    await ensureEmbedder();
    if(classifier.getNumClasses()===0) return {label:'none', confidences:{none:1}};
    const logits=embed(img); const res=await classifier.predictClass(logits); logits.dispose(); return res;
  }
  function saveKNN(){
    try{ const ds=classifier.getClassifierDataset(); const obj={}; Object.keys(ds).forEach(k=> obj[k]=Array.from(ds[k].dataSync())); const json=JSON.stringify({emb: EMB, data: obj}); localStorage.setItem(MODEL_KEY,json); const kb=Math.round(json.length/1024); alert('××•×“×œ × ×©××¨ (â‰ˆ'+kb+'KB)'); const st=document.getElementById('status'); if(st) st.textContent='××•×“×œ × ×©××¨ Â· ~'+kb+'KB'; }catch(e){ alert('×©××™×¨×” × ×›×©×œ×”'); }
  }
  function loadKNN(){
    try{ const raw=localStorage.getItem(MODEL_KEY); if(!raw) return alert('××™×Ÿ ××•×“×œ ×©××•×¨'); const parse=JSON.parse(raw); const obj=parse.data||parse; const dim=(parse.emb||EMB||1001); const to={}; Object.keys(obj).forEach(k=> to[k]=tf.tensor2d(obj[k], [obj[k].length/dim, dim])); classifier.setClassifierDataset(to); const kb=Math.round(raw.length/1024); alert('××•×“×œ × ×˜×¢×Ÿ Â· ~'+kb+'KB'); const st=document.getElementById('status'); if(st) st.textContent='××•×“×œ × ×˜×¢×Ÿ Â· ~'+kb+'KB'; refreshCounts(); }catch(e){ alert('×˜×¢×™× ×” × ×›×©×œ×”'); }
  }
  function exportKNN(){
    try{ const ds=classifier.getClassifierDataset(); const obj={}; Object.keys(ds).forEach(k=> obj[k]=Array.from(ds[k].dataSync())); const json=JSON.stringify({emb: EMB, data: obj}); const kb=Math.round(json.length/1024); const blob=new Blob([json],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rummi_knn_v2.16-ml.json'; a.click(); const st=document.getElementById('status'); if(st) st.textContent='×™×™×¦×•× Â· ~'+kb+'KB'; }catch(e){ alert('×™×™×¦×•× × ×›×©×œ'); }
  }
  async function importKNN(file){
    try{ const text=await file.text(); const parse=JSON.parse(text); const obj=parse.data||parse; const dim=(parse.emb||EMB||1001); const to={}; Object.keys(obj).forEach(k=> to[k]=tf.tensor2d(obj[k], [obj[k].length/dim, dim])); classifier.setClassifierDataset(to); const kb=Math.round(text.length/1024); alert('×™×•×‘× Â· ~'+kb+'KB'); const st=document.getElementById('status'); if(st) st.textContent='×™×•×‘× Â· ~'+kb+'KB'; refreshCounts(); }catch(e){ alert('×™×™×‘×•× × ×›×©×œ'); }
  }

  // ===== Detection helpers (unchanged) =====
  function iou(a,b){ const x1=Math.max(a.x,b.x), y1=Math.max(a.y,b.y); const x2=Math.min(a.x+a.width,b.x+b.width); const y2=Math.min(a.y+a.height,b.y+b.height); const w=Math.max(0,x2-x1), h=Math.max(0,y2-y1); const inter=w*h; const ua=a.width*a.height + b.width*b.height - inter; return ua>0? inter/ua : 0; }
  function centerInside(inner, outer){ const cx=inner.x+inner.width/2, cy=inner.y+inner.height/2; return cx>outer.x && cx<outer.x+outer.width && cy>outer.y && cy<outer.y+outer.height; }
  function nmsMerge(rects){
    if(rects.length<=1) return rects.slice();
    rects = rects.slice().sort(function(a,b){ return (b.width*b.height)-(a.width*a.height); });
    var nms=[];
    rects.forEach(function(r){ var ok=true; for(var i=0;i<nms.length;i++){ if(iou(nms[i],r)>=0.25){ ok=false; break; } } if(ok) nms.push(r); });
    var areas = nms.map(function(r){ return r.width*r.height; }).sort(function(a,b){return a-b;});
    var med = areas[Math.floor(areas.length/2)]||1;
    var filtered = nms.filter(function(r){ return (r.width*r.height) >= med*0.4; });
    filtered = filtered.filter(function(r,i){
      for(var j=0;j<filtered.length;j++){
        if(i===j) continue;
        var k=filtered[j];
        if(centerInside(r,k) && (k.width*k.height) >= (r.width*r.height)*1.6) return false;
      }
      return true;
    });
    return filtered;
  }

  // ===== OpenCV segmentation =====
  async function ensureCvReady(){
    return new Promise(function(resolve,reject){
      if (typeof cv!=='undefined' && cv.Mat) return resolve();
      var t=setInterval(function(){ if (typeof cv!=='undefined' && cv.Mat){ clearInterval(t); resolve(); } },50);
      setTimeout(function(){ clearInterval(t); reject(new Error('OpenCV ×œ× × ×˜×¢×Ÿ')); },8000);
    });
  }
  async function segmentTiles(imageBitmap){
    await ensureCvReady();
    const maxSide=1400;
    const scale=Math.min(maxSide/imageBitmap.width,maxSide/imageBitmap.height,1);
    const w=Math.round(imageBitmap.width*scale), h=Math.round(imageBitmap.height*scale);
    const cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h;
    const ctx=cvs.getContext('2d'); ctx.drawImage(imageBitmap,0,0,w,h);
    let src=cv.imread(cvs);
    let gray=new cv.Mat(); cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
    let blur=new cv.Mat(); cv.GaussianBlur(gray,blur,new cv.Size(5,5),0);
    let bin=new cv.Mat(); cv.adaptiveThreshold(blur,bin,255,cv.ADAPTIVE_THRESH_GAUSSIAN_C,cv.THRESH_BINARY_INV,35,7);
    let kernel=cv.Mat.ones(3,3,cv.CV_8U);
    let closed=new cv.Mat(); cv.morphologyEx(bin,closed,cv.MORPH_CLOSE,kernel);
    let opened=new cv.Mat(); cv.morphologyEx(closed,opened,cv.MORPH_OPEN,kernel);
    let contours=new cv.MatVector(), hierarchy=new cv.Mat();
    cv.findContours(opened,contours,hierarchy,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);
    const rects=[];
    for(let i=0;i<contours.size();i++){
      const rect=cv.boundingRect(contours.get(i));
      const ar=rect.width/rect.height;
      const area=rect.width*rect.height;
      if(area>(w*h*0.016) && ar>0.55 && ar<0.95){
        rects.push(rect);
      }
    }
    const kept = nmsMerge(rects);
    const tiles=[];
    kept.forEach(function(rect){
      const pad=Math.round(rect.height*0.08);
      const x=Math.max(0,rect.x+pad), y=Math.max(0,rect.y+pad);
      const ch=Math.min(h-y, Math.round(rect.height*0.6));
      const cw=Math.min(w-x, rect.width-pad*2);
      const c=document.createElement('canvas'); c.width=cw; c.height=ch;
      c.getContext('2d').drawImage(cvs,x,y,cw,ch,0,0,cw,ch);
      tiles.push({canvas:c, rect:rect});
    });
    contours.delete(); hierarchy.delete(); src.delete(); gray.delete(); blur.delete(); bin.delete(); closed.delete(); opened.delete(); kernel.delete();
    tiles.sort(function(a,b){ return a.rect.y===b.rect.y ? a.rect.x-b.rect.x : a.rect.y-b.rect.y; });
    return tiles;
  }

  // ===== OCR fallback =====
  async function ocrFallback(canvas){
    try{
      const r=await Tesseract.recognize(canvas,'eng',{config:'tessedit_char_whitelist=0123456789 --psm 10'});
      const t=(r.data&&r.data.text||'').trim();
      let m=t.match(/\\b1[0-3]\\b/); if(m) return parseInt(m[0],10);
      m=t.match(/\\b[0-9]\\b/); if(m) return parseInt(m[0],10);
    }catch(e){}
    return null;
  }

  // ===== Last detected preview =====
  const lastCanvas=document.getElementById('lastTile'); const lastLabel=document.getElementById('lastLabel');
  function setLastPreview(fromCanvas,labelText){
    const ctx=lastCanvas.getContext('2d');
    lastCanvas.width=64; lastCanvas.height=64;
    ctx.clearRect(0,0,64,64);
    if(fromCanvas) ctx.drawImage(fromCanvas,0,0,64,64);
    lastLabel.textContent=labelText||'â€”';
  }
  document.getElementById('clearLast')?.addEventListener('click', function(){ setLastPreview(null,'â€”'); });

  async function classifyTile(canvas){
    const res=await predictClass(canvas);
    if(res && res.label!=='none'){
      const n=parseInt(res.label,10);
      const conf=res.confidences[res.label]||0;
      if(n>=1 && n<=13 && conf>=settings.conf) return {n:n, conf:conf, via:'ML'};
    }
    const v=await ocrFallback(canvas);
    if(v!=null) return {n:v, conf:0, via:'OCR'};
    return null;
  }
  async function detectFromFile(file, mount, playerId, mode){
    const bmp=await createImageBitmap(file);
    const tiles=await segmentTiles(bmp);
    const thumbs=document.getElementById('thumbs');
    const got=[];
    for(const t of tiles){
      const r=await classifyTile(t.canvas);
      if(r){
        got.push(r.n);
        const tn=document.createElement('canvas'); tn.width=96; tn.height=96;
        tn.getContext('2d').drawImage(t.canvas,0,0,96,96);
        const wrap=document.createElement('div'); wrap.className='thumb'; wrap.appendChild(tn);
        const sp=document.createElement('span'); sp.textContent = r.n + (r.via==='ML'? (' Â· '+r.conf.toFixed(2)) : ' Â· OCR');
        wrap.appendChild(sp); thumbs.appendChild(wrap);
        setLastPreview(t.canvas, '×§×•×‘×™×”: '+r.n + (r.via==='ML'? (' (×‘×˜×—×•×Ÿ '+r.conf.toFixed(2)+')') : ' (OCR)'));
      }
      await tf.nextFrame();
    }
    if(got.length){
      const s = got.reduce(function(a,b){return a+b;},0);
      if(mode==='replace') setPoints(playerId, s); else addPoints(playerId, s);
      mount.textContent = '×–×•×”×•: ' + got.join(' + ') + ' = ' + s + (mode==='replace' ? ' (×”×•×—×œ×£)' : ' (× ×•×¡×£)');
    }else{
      mount.textContent='×œ× ×–×•×”×• ×§×•×‘×™×•×ª.';
    }
  }

  // ===== Game logic =====
  function startGame(){
    const names=['#n0','#n1','#n2','#n3'].map(function(sel){ const e=document.querySelector(sel); return e?e.value.trim():''; }).filter(function(v){return !!v;});
    const list=names.length?names:['×©×—×§×Ÿ 1','×©×—×§×Ÿ 2'];
    state.players=list.map(function(n,i){ return {id:String(i+1), name:n, points:0}; });
    save(); showGame();
  }
  function showGame(){ document.getElementById('s1').classList.add('hidden'); document.getElementById('s2').classList.remove('hidden'); render(); window.scrollTo({top:0,behavior:'smooth'}); }
  function backToNames(){ document.getElementById('s2').classList.add('hidden'); document.getElementById('s1').classList.remove('hidden'); }
  function addPoints(id,delta){ const p=state.players.find(function(x){return x.id===id;}); if(!p) return; p.points+=delta; save(); render(); }
  function setPoints(id,val){ const p=state.players.find(function(x){return x.id===id;}); if(!p) return; p.points=val; save(); render(); }

  function render(){
    const board=document.getElementById('board'); board.innerHTML='';
    const sorted=state.players.slice().sort(function(a,b){ return b.points-a.points; });
    sorted.forEach(function(p,i){
      const div=document.createElement('div'); div.className='chip';
      div.innerHTML='<div class="rank">'+(i+1)+'</div><div>'+p.name+(i===0?' ğŸ‘‘':'')+'</div><div style="margin-inline-start:auto">'+p.points+' × ×§×³</div>';
      board.appendChild(div);
    });

    const panels=document.getElementById('panels'); panels.innerHTML='';
    state.players.forEach(function(p){
      const card=document.createElement('div'); card.className='card';
      const head=document.createElement('div'); head.className='row';
      const title=document.createElement('h3'); title.style.margin='0'; title.textContent=p.name;
      const mount=document.createElement('div'); mount.className='mini'; mount.textContent='×‘×—×¨/×™ ×ª××•× ×” ×©×œ ×”×§×•×‘×™×•×ª.';
      const fileReplace=document.createElement('input'); fileReplace.type='file'; fileReplace.accept='image/*'; fileReplace.className='hidden';
      const fileAdd=document.createElement('input'); fileAdd.type='file'; fileAdd.accept='image/*'; fileAdd.className='hidden';
      const uploadBtn=document.createElement('button'); uploadBtn.className='ghost'; uploadBtn.textContent=' ×”×¢×œ×” ×ª××•× ×” (×”×—×œ×£)';
      const addBtn=document.createElement('button'); addBtn.className='ghost'; addBtn.textContent=' ×”×¢×œ×” ×•×¢×•×“ (×¦×‘×•×¨)';
      uploadBtn.addEventListener('click', function(){ fileReplace.click(); });
      addBtn.addEventListener('click', function(){ fileAdd.click(); });
      fileReplace.addEventListener('change', function(e){ const f=e.target.files[0]; if(f){ mount.textContent='×× ×ª×—â€¦'; detectFromFile(f,mount,p.id,'replace'); } e.target.value=''; });
      fileAdd.addEventListener('change', function(e){ const f=e.target.files[0]; if(f){ mount.textContent='×× ×ª×—â€¦'; detectFromFile(f,mount,p.id,'add'); } e.target.value=''; });
      head.appendChild(title); head.appendChild(uploadBtn); head.appendChild(addBtn);
      card.appendChild(head); card.appendChild(fileReplace); card.appendChild(fileAdd);
      const meta=document.createElement('div'); meta.innerHTML='× ×§×•×“×•×ª × ×•×›×—×™×•×ª: <span class="pill">'+p.points+'</span>';
      card.appendChild(meta);
      const ctrls=document.createElement('div'); ctrls.className='row';
      const num=document.createElement('input'); num.type='number'; num.placeholder='+/-';
      const go=document.createElement('button'); go.textContent='×”×•×¡×£/×”×¤×—×ª';
      go.addEventListener('click', function(){ const d=Number(num.value); if(!Number.isNaN(d) && num.value!==''){ addPoints(p.id,d); num.value=''; } });
      const minus10=document.createElement('button'); minus10.textContent='-10'; minus10.addEventListener('click', function(){ addPoints(p.id,-10); });
      ctrls.appendChild(num); ctrls.appendChild(go); ctrls.appendChild(minus10);
      card.appendChild(ctrls);
      card.appendChild(mount);
      panels.appendChild(card);
    });
  }

  // Wire buttons
  document.getElementById('startBtn')?.addEventListener('click', startGame);
  document.getElementById('backBtn')?.addEventListener('click', backToNames);
  document.getElementById('resetBtn')?.addEventListener('click', function(){ if(confirm('×œ××¤×¡ ××ª ×›×œ ×”× ×§×•×“×•×ª?')){ state.players.forEach(function(p){ p.points=0; }); save(); render(); } });
  document.getElementById('clearResults')?.addEventListener('click', function(){ document.getElementById('thumbs').innerHTML=''; setLastPreview(null,'â€”'); });
  document.getElementById('toggleTrainer')?.addEventListener('click', function(){ document.getElementById('trainer').classList.toggle('hidden'); });
  document.getElementById('addFromGallery')?.addEventListener('click', function(){ const picker=document.getElementById('filePick'); const cls=document.getElementById('cls').value; picker.onchange=async function(e){ const files=Array.from(e.target.files); await addMany(files,cls); picker.value=''; }; picker.click(); });
  document.getElementById('captureOne')?.addEventListener('click', async function(){
    const cls=document.getElementById('cls').value;
    try{
      const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      const v=document.createElement('video'); v.playsInline=true; v.muted=true; v.srcObject=s; await v.play();
      await new Promise(function(r){ setTimeout(r,400); });
      const c=document.createElement('canvas'); c.width=224; c.height=224;
      const ctx=c.getContext('2d'); const vw=v.videoWidth, vh=v.videoHeight;
      const size=Math.min(vw,vh);
      ctx.drawImage(v,(vw-size)/2,(vh-size)/2,size,size,0,0,224,224);
      await addExample(c,cls);
      s.getTracks().forEach(function(t){ t.stop(); });
      const el=document.getElementById('status'); if(el) el.textContent='× ×•×¡×¤×” ×“×•×’××” ×¢×‘×•×¨ '+cls;
    }catch(e){ alert('×‘×¢×™×” ×‘×’×™×©×” ×œ××¦×œ××”'); }
  });
  document.getElementById('saveModel')?.addEventListener('click', saveKNN);
  document.getElementById('loadModel')?.addEventListener('click', loadKNN);
  document.getElementById('exportModel')?.addEventListener('click', exportKNN);
  document.getElementById('importModel')?.addEventListener('click', function(){ document.getElementById('importFile').click(); });
  document.getElementById('importFile')?.addEventListener('change', function(e){ if(e.target.files[0]) importKNN(e.target.files[0]); });

  function datasetCounts(){ const ds=classifier.getClassifierDataset(); const keys=Object.keys(ds); if(!keys.length) return '××™×Ÿ ×“×•×’×××•×ª'; const parts=keys.map(function(k){ return k+': '+(ds[k].shape[0]||0); }); return parts.join(' | '); }
  function refreshCounts(){ const cr=document.getElementById('countsRow'); if(cr) cr.textContent='×“×•×’×××•×ª ×œ××¡×¤×¨×™×: '+datasetCounts(); }

  if(state.players && state.players.length){ showGame(); }
});
</script>
</body>
</html>
