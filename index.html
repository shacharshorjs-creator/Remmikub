<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>רמיקוב – אימון מודל (v3.2-ml)</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#94a3b8; --accent:#38bdf8; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    --text:#e5e7eb;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:920px;margin:40px auto;padding:0 16px}
  h1{font-size:1.5rem;margin:0 0 8px}
  .badge{display:inline-block;padding:4px 10px;margin-inline:6px;border-radius:999px;background:#1f2937;color:#cbd5e1;font-size:.85rem}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .card{background:var(--card);border-radius:14px;padding:16px;margin-top:16px;box-shadow:0 0 0 1px #1f2937;}
  .controls{display:flex;gap:10px;flex-wrap:wrap}
  button,.btn{background:#0ea5e9;border:none;color:white;padding:10px 14px;border-radius:10px;font-weight:600}
  button.secondary{background:#374151}
  button.ok{background:var(--ok)}
  button.warn{background:var(--warn)}
  input[type="file"]{display:block;margin-top:8px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .banner{position:sticky;top:0;z-index:10;display:none;margin-bottom:8px;background:#0b3b4a;border:1px solid #155e75;border-radius:12px;padding:10px 12px}
  .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .thumbs img{width:80px;height:80px;object-fit:cover;border-radius:10px;border:1px solid #1f2937}
  pre{background:#0b1220;border-radius:12px;padding:12px;overflow:auto;border:1px solid #1f2937}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <h1>אימון מודל זיהוי (KNN + MobileNet)</h1>
    <span class="badge" id="ver">v3.2-ml</span>
    <span class="badge" id="tfBadge">TF: init</span>
    <span class="badge" id="modelBadge">model: —</span>
  </div>

  <div id="banner" class="banner"></div>

  <div class="card">
    <div class="controls">
      <label>בחר/י מחלקה (מספר): 
        <select id="selClass">
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4" selected>4</option>
          <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
          <option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
          <option value="13">13</option>
        </select>
      </label>
      <button id="btnClearClass" class="secondary">נקה מחלקה</button>
      <button id="btnClearAll" class="warn">נקה הכל</button>
      <button id="btnExport" class="ok">ייצא JSON</button>
      <label class="btn">
        ייבא JSON<input id="fileImport" type="file" accept="application/json" hidden>
      </label>
      <button id="btnSaveLS" class="secondary">שמור מקומית</button>
      <button id="btnLoadLS" class="secondary">טען מקומית</button>
    </div>
    <div class="grid">
      <div>
        <strong>הוסף תמונה בודדת</strong>
        <input id="filePickOne" type="file" accept="image/*" capture="environment">
      </div>
      <div>
        <strong>בחר/י קבצים (גלריה)</strong>
        <input id="filePickMulti" type="file" accept="image/*" multiple>
      </div>
      <div>
        <strong>צילום מהמצלמה</strong>
        <input id="filePickCam" type="file" accept="image/*" capture="environment">
      </div>
    </div>
    <div class="thumbs" id="thumbs"></div>
  </div>

  <div class="card">
    <strong>Debug:</strong>
    <pre id="dbg">—</pre>
  </div>
</div>

<!-- TFJS + Models -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier@1.2.2"></script>

<script>
const $$ = sel => document.querySelector(sel);
const dbg = msg => { const el=$$('#dbg'); el.textContent = (el.textContent==='—'?'':el.textContent+'\n') + msg; el.scrollTop=el.scrollHeight; };
const banner = (txt) => { const b=$$('#banner'); b.style.display='block'; b.textContent = txt; setTimeout(()=>{b.style.display='none';}, 3500); };
function showBanner(txt){ banner(txt); $$('#modelBadge').textContent = txt; }

let knn, mobilenetModel;

// Force CPU backend (יציב יותר במובייל)
(async function initTF(){
  try{
    await tf.setBackend('cpu');
    await tf.ready();
    $$('#tfBadge').textContent = 'TF: '+tf.getBackend();
    dbg('backend: '+tf.getBackend());
  }catch(e){
    dbg('TF init error: '+(e?.message||e));
  }
  mobilenetModel = await mobilenet.load(); // default: 224, alpha=1.0
  knn = knnClassifier.create();
  dbg('models loaded');
  tryRestoreFromLocalStorage();
})();

// UI handlers
$$('#btnClearClass').onclick = ()=> {
  const c=$$('#selClass').value;
  if (knn.hasClass(c)) knn.clearClass(c);
  banner('נוקתה מחלקה '+c);
};
$$('#btnClearAll').onclick = ()=> {
  knn.clearAllClasses();
  banner('כל הדוגמאות נוקו');
  $$('#thumbs').innerHTML='';
};
$$('#btnExport').onclick = exportModelJSON;
$$('#fileImport').onchange = (e)=>{
  const f=e.target.files?.[0]; if(f) importModelJSON(f);
  e.target.value='';
};
$$('#btnSaveLS').onclick = ()=>{
  exportModelJSON(); // גם שומר ב-LS
};
$$('#btnLoadLS').onclick = tryRestoreFromLocalStorage;

$$('#filePickOne').onchange = (e)=> addFilesToClass(e.target.files);
$$('#filePickMulti').onchange = (e)=> addFilesToClass(e.target.files);
$$('#filePickCam').onchange = (e)=> addFilesToClass(e.target.files);

async function addFilesToClass(fileList){
  if (!fileList || fileList.length===0) return;
  const cls = $$('#selClass').value;
  for (const f of fileList){
    try{
      const img = await fileToImage(f);
      const logits = tf.tidy(()=> mobilenetModel.infer(img, true)); // embedding
      await knn.addExample(logits, cls);
      addThumb(img);
      dbg('✅ added '+(f.name||'image')+' to class '+cls);
    }catch(e){
      dbg('ERR addExample '+(e?.message||e));
    }
  }
}

function addThumb(tfimg){
  const c = document.createElement('canvas');
  c.width=80; c.height=80;
  tf.browser.toPixels(tf.image.resizeBilinear(tfimg, [80,80]), c).then(()=>{
    $$('#thumbs').prepend(c);
    tfimg.dispose();
  });
}

// Read file -> tf.Tensor3D image (normalized to [0,1])
function fileToImage(file){
  return new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>{
      const img = new Image();
      img.onload = ()=>{
        tf.tidy(()=>{
          const t = tf.browser.fromPixels(img).toFloat().div(255);
          resolve(t);
        });
      };
      img.onerror=()=>reject('image load failed');
      img.src = fr.result;
    };
    fr.onerror = ()=> reject('reader failed');
    fr.readAsDataURL(file);
  });
}

/** ===== Model Save / Load (JSON) ===== */

function exportModelJSON() {
  const ds = knn.getClassifierDataset();
  const classCounts = knn.getClassExampleCount();
  const labelsMap = window.rummiLabels || {};

  if (!ds || Object.keys(ds).length === 0) {
    alert('אין דוגמאות במודל – הוסף דוגמאות לפני שמירה.');
    return;
  }
  const payload = { version: '3.2', counts: classCounts, labels: labelsMap, dataset: {} };
  let vectors=0;
  for (const [label, tensor] of Object.entries(ds)) {
    payload.dataset[label] = {
      data: Array.from(tensor.dataSync()),
      shape: tensor.shape,
      dtype: tensor.dtype || 'float32'
    };
    vectors += tensor.shape?.[0] || 0;
  }
  const json = JSON.stringify(payload);
  try { localStorage.setItem('rummi_model_json', json); } catch(e) {}
  const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `rummi_model_${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1200);
  showBanner(`saved • ${(json.length/1024).toFixed(1)} KB • vectors: ${vectors}`);
}

async function importModelJSON(file) {
  try {
    const text = await file.text();
    const obj  = JSON.parse(text);
    if (!obj || !obj.dataset || Object.keys(obj.dataset).length === 0) {
      alert('קובץ המודל ריק או לא תקין.');
      return;
    }
    const tensors = {};
    let vectors=0;
    for (const [label, rec] of Object.entries(obj.dataset)) {
      const values = Float32Array.from(rec.data);
      const shape  = rec.shape || [values.length, 1024];
      tensors[label] = tf.tensor(values, shape, 'float32');
      vectors += shape?.[0] || 0;
    }
    knn.setClassifierDataset(tensors);
    window.rummiLabels = obj.labels || {};
    try { localStorage.setItem('rummi_model_json', text); } catch(e) {}
    showBanner(`model: restored • ${(text.length/1024).toFixed(1)} KB • vectors: ${vectors}`);
  } catch (e) {
    console.error(e);
    alert('ייבוא נכשל: ' + (e?.message || e));
  }
}

async function tryRestoreFromLocalStorage() {
  try {
    const text = localStorage.getItem('rummi_model_json');
    if (!text) { $$('#modelBadge').textContent='model: —'; return; }
    const obj  = JSON.parse(text);
    if (!obj?.dataset) return;
    const tensors = {};
    let vectors=0;
    for (const [label, rec] of Object.entries(obj.dataset)) {
      const values = Float32Array.from(rec.data);
      const shape  = rec.shape;
      tensors[label] = tf.tensor(values, shape, 'float32');
      vectors += shape?.[0] || 0;
    }
    knn.setClassifierDataset(tensors);
    window.rummiLabels = obj.labels || {};
    showBanner(`model: restored • ${(text.length/1024).toFixed(1)} KB • vectors: ${vectors}`);
  } catch (e) {
    console.warn('auto-restore failed', e);
  }
}
</script>
</body>
</html>
