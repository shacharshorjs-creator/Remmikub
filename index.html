<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>×¨××™×§×•×‘ â€“ ××™××•×Ÿ ××•×“×œ ×–×™×”×•×™ (v2.57-ml)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier@1.2.2"></script>
<style>
  :root{--bg:#0e1220;--card:#141a2b;--ink:#eaf1ff;--muted:#a2b3cc;--line:rgba(255,255,255,.12);--accent:#6dd6ff;}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .appbar{position:sticky;top:0;background:#0b1222;z-index:20;border-bottom:1px solid var(--line)}
  .wrap{width:min(980px,94vw);margin:0 auto;padding:14px}
  .badges > *{display:inline-block;margin-inline-start:8px;background:#0a1a2f;border:1px solid #223b5c;padding:6px 10px;border-radius:999px;font-size:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:14px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  button{border:none;border-radius:12px;background:#1d2743;color:#fff;padding:8px 12px;cursor:pointer}
  .danger{background:#3a1c1c;border:1px solid #5a2b2b}
  .drop{position:relative;border:2px dashed #34507a;border-radius:16px;padding:18px;text-align:center;background:#0d162b;user-select:none;overflow:hidden}
  .drop.drag{background:#0f1c36;border-color:#5984d6}
  .drop input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer}
  .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .thumbs img{width:74px;height:74px;object-fit:cover;border-radius:10px;border:1px solid #2b3f63}
  pre{white-space:pre-wrap;background:#0a1020;border:1px solid var(--line);padding:10px;border-radius:12px;max-height:280px;overflow:auto}
</style>
</head>
<body>
<header class="appbar">
  <div class="wrap row" style="justify-content:space-between">
    <div class="badges">
      <span>×¨××™×§×•×‘ â€“ ××™××•×Ÿ ××•×“×œ ×–×™×”×•×™</span>
      <span id="ver" title="×’×¨×¡×”">v2.57-ml</span>
      <span id="tfBadge">TF: initâ€¦</span>
    </div>
    <div class="badges">
      <span id="counts">×“×•×’×××•×ª: â€”</span>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="row">
      <label for="cls">×‘×—×¨/×™ ××¡×¤×¨</label>
      <select id="cls">
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option><option>13</option>
      </select>
      <button id="btnClear" class="danger">× ×§×” ×”×›×œ</button>
    </div>

    <div id="drop" class="drop" style="margin-top:12px">
      ×’×¨×¨×• ×ª××•× ×•×ª ×œ×›××Ÿ ××• ×œ×—×¦×• ×œ×‘×—×™×¨×”
      <input id="file" type="file" accept="image/*,.heic,.heif" multiple>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnCam">ğŸ“· ××¦×œ××”</button>
      <input id="cam" type="file" accept="image/*" capture="environment" style="display:none">
      <progress id="prog" max="1" value="0" style="width:200px"></progress>
      <span id="status" style="font-size:12px;color:var(--muted)"></span>
    </div>

    <div id="thumbs" class="thumbs"></div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between"><b>Debug</b>
        <button id="copyDbg">ğŸ“‹ ×”×¢×ª×§</button></div>
      <pre id="dbg"></pre>
    </div>
  </section>
</main>

<canvas id="work" width="224" height="224" style="display:none"></canvas>

<script>
let net, classifier;
const dbg = (m)=>{ const el=document.getElementById('dbg'); el.textContent += (el.textContent?'\n':'')+m; el.scrollTop=el.scrollHeight; };

function setCounts(){
  const ds = classifier.getClassifierDataset(); const ks = Object.keys(ds);
  const txt = ks.length? ks.map(k=> k+': '+(ds[k].shape[0]||0)).join(' | ') : 'â€”';
  document.getElementById('counts').textContent = '×“×•×’×××•×ª: '+txt;
}

async function init(){
  try{ await tf.setBackend('cpu'); await tf.ready(); document.getElementById('tfBadge').textContent = 'TF: '+tf.getBackend(); dbg('backend: '+tf.getBackend()); }
  catch(e){ dbg('TF init error: '+(e&&e.message||e)); }
  try{ net = await mobilenet.load({version:2, alpha:0.35}); classifier = knnClassifier.create(); dbg('models loaded'); }
  catch(e){ dbg('model load error: '+(e&&e.message||e)); }
}

function addThumb(src){
  const img=new Image(); img.src=src; img.className='thumb';
  document.getElementById('thumbs').appendChild(img);
}

function waitImage(url){
  return new Promise((resolve,reject)=>{
    const img=new Image(); img.onload=()=>resolve(img); img.onerror=()=>reject(new Error('image load failed')); img.src=url;
  });
}

async function toTensor(img){
  // Draw to 224x224 canvas to avoid IndexSizeError from zero/EXIF rotations.
  const c=document.getElementById('work'), ctx=c.getContext('2d', { willReadFrequently:true });
  const s=Math.min(img.naturalWidth||img.width, img.naturalHeight||img.height) || 1;
  const sx=((img.naturalWidth||img.width)-s)/2; const sy=((img.naturalHeight||img.height)-s)/2;
  ctx.clearRect(0,0,224,224); ctx.drawImage(img, sx, sy, s, s, 0, 0, 224, 224);
  return tf.tidy(()=> tf.browser.fromPixels(c));
}

async function handleFileList(list){
  if(!list || !list.length) return;
  if(!net || !classifier){ dbg('models not ready'); return; }
  const cls = document.getElementById('cls').value;
  const prog=document.getElementById('prog'); prog.max=list.length; prog.value=0;
  let ok=0, fail=0;
  for (const f of list){
    try{
      const url=URL.createObjectURL(f);
      addThumb(url);
      const img=await waitImage(url); URL.revokeObjectURL(url);
      const px=await toTensor(img);
      const emb=tf.tidy(()=> net.infer(px.expandDims(0),'conv_preds'));
      classifier.addExample(emb, cls); emb.dispose(); px.dispose(); ok++;
      dbg('âœ… added '+f.name+' to class '+cls);
    }catch(e){ fail++; dbg('ERR addExample '+(e&&e.message||e)); }
    prog.value = ok+fail;
  }
  document.getElementById('status').textContent = '×”×•×¡×¤×• '+ok+' | × ×›×©×œ×• '+fail;
  setCounts();
}

window.addEventListener('DOMContentLoaded',()=>{
  init();
  const drop=document.getElementById('drop');
  const file=document.getElementById('file');
  const cam=document.getElementById('cam');
  document.getElementById('btnCam').onclick=()=> cam.click();
  document.getElementById('btnClear').onclick=()=>{ classifier.clearAllClasses(); setCounts(); dbg('dataset cleared'); document.getElementById('thumbs').innerHTML=''; };
  document.getElementById('copyDbg').onclick=()=> navigator.clipboard.writeText(document.getElementById('dbg').textContent||'');

  file.addEventListener('change', e=>{ dbg('filePick '+(e.target.files?.length||0)); handleFileList(e.target.files); });
  cam.addEventListener('change', e=>{ dbg('camPick '+(e.target.files?.length||0)); handleFileList(e.target.files); });

  ;['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); }, false));
  ;['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); }, false));
  drop.addEventListener('drop', e=>{ handleFileList(e.dataTransfer.files); }, false);
  drop.addEventListener('click', ()=> file.click());
});
</script>
</body>
</html>
