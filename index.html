<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>×¨××™×§×•×‘ â€“ × ×™×§×•×“ + ××™××•×Ÿ (CPU)</title>
<style>
  :root{
    --bg:#0f1724; --panel:#121c2b; --muted:#9fb3c8; --text:#eaf6ff;
    --acc:#89e3ff; --good:#2ecc71; --bad:#c14949;
  }
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b1420,#0e1623 40%,#0b1420);
       color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji",sans-serif}
  .wrap{max-width:920px;margin:0 auto;padding:14px 14px 48px}
  .row{display:flex;flex-wrap:wrap;gap:12px}
  .pill{display:inline-flex;align-items:center;gap:.5rem;padding:.35rem .7rem;border-radius:999px;background:#122235;color:#d7edff;font-size:.9rem}
  .muted{color:var(--muted)}
  h2{margin:.6rem 0 0.2rem;font-size:1.35rem}
  h3{margin:1rem 0 .4rem;font-size:1.1rem;color:#cfeaff}
  .card{background:var(--panel);border-radius:14px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.25);margin:10px 0}
  .board .thead, .board .row{display:grid;grid-template-columns:42px 1fr 100px 190px;gap:10px;align-items:center}
  .board .thead{opacity:.8;padding-bottom:6px;border-bottom:1px solid #1e2a3c}
  .board .row{padding:6px 0;border-bottom:1px dashed #1a2537}
  .btn{border:0;border-radius:10px;padding:.48rem .7rem;background:#16314a;color:#e9f6ff;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  .btn.bad{background:#3a1e26;color:#ffc7c7}
  .btn.good{background:#113021;color:#c6ffd9}
  .btn.acc{background:#14344a;color:#bfefff}
  .btn.cam{display:inline-flex;gap:.35rem;align-items:center}
  input[type="text"], input[type="number"]{width:100%;padding:.48rem .6rem;border-radius:10px;background:#0d1522;border:1px solid #1c2a3c;color:#eaf6ff}
  .hint{font-size:.85rem;color:#94adc4}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .kbd{background:#0b1420;border:1px solid #203049;padding:.15rem .45rem;border-radius:6px}
  .sep{height:1px;background:#1a2738;margin:.75rem 0}
  .footer{position:sticky;bottom:0;backdrop-filter:blur(8px);background:rgba(8,13,22,.75);border-top:1px solid #22324a;padding:10px;margin:0 -14px}
  small.tag{background:#0f263a;color:#d2f1ff;border:1px solid #234761;border-radius:999px;padding:.15rem .55rem;margin-inline-end:.35rem}
  .ghost{opacity:.35}
  .flex{display:flex;gap:.5rem;align-items:center}
  .btn.inline{padding:.35rem .55rem;border-radius:8px}
  .nowrap{white-space:nowrap}
  .danger{color:#ffb2b2}
  .ok{color:#baffc3}
  .scrollx{overflow:auto}
  .copybtn{margin-inline-start:.5rem}
</style>
</head>
<body>
<div class="wrap" id="app">
  <div class="row" style="justify-content:space-between;align-items:center">
    <div class="flex">
      <small class="tag" id="verBadge">v4.2-ml</small>
      <small class="tag" id="tfBadge">TF: init</small>
      <small class="tag" id="modelBadge">model: â€”</small>
      <small class="tag" id="examplesBadge">×“×•×’×××•×ª: â€”</small>
    </div>
    <div class="flex">
      <button class="btn inline" id="btnResetScores">××™×¤×•×¡ × ×§×•×“×•×ª</button>
      <button class="btn inline" id="btnSaveNames">×©××•×¨ ×©××•×ª</button>
    </div>
  </div>

  <!-- ×œ×•×— ×”×•×‘×œ×” ×™×—×™×“ -->
  <div class="card board" id="leaderCard">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">×œ×•×— ×”×•×‘×œ×”</h2>
      <div class="hint">×‘×—×¨×• ××©×ª×ª×¤×™× ×œ××˜×”. ×œ×—×™×¦×” ×¢×œ <span class="kbd">+10</span>/<span class="kbd">-10</span> ×ª×¢×“×›×Ÿ × ×§×•×“×•×ª, ××• ×”×•×¡×™×¤×• ×™×“× ×™×ª.</div>
    </div>
    <div class="thead">
      <div>#</div>
      <div>×©×</div>
      <div>× ×§×•×“×•×ª</div>
      <div>×¤×¢×•×œ×•×ª</div>
    </div>
    <div id="boardRows"></div>
  </div>

  <!-- ×‘×—×™×¨×ª ××©×ª×ª×¤×™× -->
  <div class="card">
    <h2>×‘×—×™×¨×ª ××©×ª×ª×¤×™× (×¢×“ 4)</h2>
    <div class="grid2">
      <div><label class="hint">×©×—×§×Ÿ 1</label><input id="p1" type="text" placeholder="×©×" /></div>
      <div><label class="hint">×©×—×§×Ÿ 2</label><input id="p2" type="text" placeholder="×©×" /></div>
      <div><label class="hint">×©×—×§×Ÿ 3</label><input id="p3" type="text" placeholder="×©×" /></div>
      <div><label class="hint">×©×—×§×Ÿ 4</label><input id="p4" type="text" placeholder="×©×" /></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn acc" id="btnStart">×”×ª×—×œ ××©×—×§</button>
      <div class="hint">×”×©××•×ª × ×©××¨×™× ××§×•××™×ª.</div>
    </div>
  </div>

  <!-- ××™××•×Ÿ ××•×“×œ â€“ ×ª××™×“ ×’×œ×•×™ (×¢×œ ×”××›×©×™×¨) -->
  <div class="card" id="trainCard">
    <h2>××™××•×Ÿ ××•×“×œ ×–×™×”×•×™ (CPU)</h2>
    <div class="hint">upload â†’ embedding (MobileNet) â†’ KNN â€¢ ×”××•×“×œ × ×©××¨/× ×˜×¢×Ÿ ×Ö¾localStorage (×œ× × ×©×œ×— ×œ×¨×©×ª).</div>
    <div class="sep"></div>
    <div class="row" style="align-items:center;gap:10px">
      <label class="hint">×‘×—×¨/×™ ××—×œ×§×” (××¡×¤×¨):</label>
      <input id="classId" type="number" min="1" max="4" value="1" style="width:5rem"/>
      <button class="btn inline" id="btnNukeExamples">× ×§×” ×”×›×œ</button>
      <button class="btn inline" id="btnSaveModel">×©××•×¨ ××•×“×œ</button>
      <button class="btn inline" id="btnLoadModel">×©×—×–×¨ ××•×“×œ</button>
      <button class="btn inline" id="btnExportJSON">JSON ×™×™×¦×</button>
      <label class="btn inline nowrap">
        ×™×™×‘× JSON
        <input id="jsonIn" type="file" accept="application/json" hidden>
      </label>
      <span class="hint">××¦×‘: <span id="statusSpan">××•×›×Ÿ</span></span>
    </div>
    <div class="row" style="margin-top:10px;align-items:center;gap:10px">
      <label class="btn inline nowrap">
        ×”×•×¡×£ ××’×–â€™×™×¨ (×’×œ×¨×™×”)
        <input id="filePick" type="file" accept="image/*" multiple hidden>
      </label>
      <label class="btn inline nowrap">
        ×¦×™×œ×•× ××”××¦×œ××”
        <input id="filePickCam" type="file" accept="image/*" capture="environment" hidden>
      </label>
    </div>
    <div class="sep"></div>
    <div class="scrollx">
      <pre id="debug" style="min-height:80px;margin:0;background:#0b1420;border:1px solid #22324a;border-radius:12px;padding:10px;white-space:pre-wrap"></pre>
    </div>
  </div>

  <div class="footer row" style="justify-content:space-between">
    <div class="hint">×§×™×¦×•×¨ ×“×¨×š: <span class="kbd">×©××•×¨ ××•×“×œ</span> ×©×•××¨ ×œÖ¾localStorage â€¢ <span class="kbd">×©×—×–×¨ ××•×“×œ</span> ×˜×•×¢×Ÿ ××•×˜×•××˜×™×ª ×¢× ×¤×ª×™×—×ª ×”×¢××•×“.</div>
    <div class="muted">Â© v4.2-ml</div>
  </div>
</div>

<!-- TFJS + MobileNet + KNN (×’×¨×¡××•×ª ×©× ×‘×“×§×•) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier@1.2.2"></script>

<script>
const VERSION = 'v4.2-ml';
const $$ = sel => document.querySelector(sel);
const on = (el,ev,fn) => el.addEventListener(ev,fn);
const log = msg => { const d=$$('#debug'); d.textContent += (d.textContent? '\\n':'') + msg; d.scrollTop=d.scrollHeight; };

// ====== ××¦×‘ ××¤×œ×™×§×¦×™×” ×‘×¡×™×¡×™ (×©××•×ª + × ×™×§×•×“) ======
let players = []; // {name, score}
function loadNames(){
  const saved = JSON.parse(localStorage.getItem('rk_players') || '[]');
  for(let i=0;i<4;i++){
    const val = saved[i]?.name || '';
    $$('#p'+(i+1)).value = val;
  }
}
function saveNames(){
  players = [];
  for(let i=0;i<4;i++){
    const name = ($$('#p'+(i+1)).value || '').trim() || ('×©×—×§×Ÿ ' + (i+1));
    players.push({name, score:0});
  }
  localStorage.setItem('rk_players', JSON.stringify(players));
}
function renderBoard(){
  const holder = $$('#boardRows'); holder.innerHTML='';
  players.forEach((p,idx)=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML = `
      <div>${idx+1}</div>
      <div>${p.name}</div>
      <div><span id="sc_${idx}">${p.score}</span></div>
      <div class="flex">
        <button class="btn good" data-d="+10">+10</button>
        <button class="btn bad" data-d="-10">-10</button>
        <input class="manual" type="number" placeholder="×¢×¨×š" style="width:92px">
        <button class="btn acc" data-d="manual">×”×•×¡×£</button>
        <label class="btn cam nowrap">ğŸ“·
          <input class="snap" type="file" accept="image/*" capture="environment" hidden>
        </label>
      </div>`;
    holder.appendChild(row);
    // ××™×¨×•×¢×™×
    const [bPlus,bMinus,inputManual,bManual,labelCam] = row.querySelectorAll('button,input,label');
    bPlus.onclick=()=>bump(idx, +10);
    bMinus.onclick=()=>bump(idx, -10);
    bManual.onclick=()=>{
      const v = parseInt(inputManual.value||'0',10);
      if(!isNaN(v)) bump(idx, v);
    };
    labelCam.querySelector('input.snap').onchange = async (e)=>{
      // ×ª××•× ×ª ×©×—×§×Ÿ -> ×›×¨×’×¢ ×¨×§ ××¦×™×’×” ×—×™×•×•×™; (×”××•×“×œ × ×©××¨ ××•×“×•×œ ××™××•×Ÿ ×œ××˜×”).
      if(e.target.files?.length){
        log(`ğŸï¸ × ×§×œ×˜ ×¦×™×œ×•× ×œ×©×—×§×Ÿ ${idx+1} (${players[idx].name}) â€“ (×ª××™×›×” ×‘×—×™×–×•×™ ×œ×¦×™×•×Ÿ × ×©××¨×” ×œ×’×¨×¡××•×ª ×”×‘×¡×™×¡).`);
      }
    }
  });
}
function bump(index, delta){
  players[index].score += delta;
  $$('#sc_'+index).textContent = players[index].score;
  localStorage.setItem('rk_players', JSON.stringify(players));
}

// ====== ××ª×—×•×œ ×©××•×ª ×•× ×™×§×•×“ ======
loadNames();
saveNames();
renderBoard();

on($$('#btnSaveNames'),'click',()=>{ saveNames(); renderBoard(); });
on($$('#btnStart'),'click',()=>{ saveNames(); renderBoard(); });
on($$('#btnResetScores'),'click',()=>{
  players.forEach(p=>p.score=0); renderBoard();
  localStorage.setItem('rk_players', JSON.stringify(players));
});

// ====== ××•×“×•×œ ××™××•×Ÿ (MobileNet+KNN) â€“ ×›××• ×‘×’×¨×¡×” ×”×‘×¡×™×¡×™×ª, ×œ×œ× ×©×™× ×•×™ ××”×•×ª×™ ======
let net, classifier;
let totalExamples = 0;

// ×”×›×¨×—×ª CPU â€“ ×œ×‘×™×¦×™×‘×•×ª ×‘××•×‘×™×™×œ
(async ()=>{
  try{
    await tf.setBackend('cpu');
  }catch(e){}
  $$('#tfBadge').textContent = 'TF: ' + tf.getBackend();
})();

async function ensureModels(){
  if(net && classifier) return;
  log('loading mobilenet/knn...');
  classifier = knnClassifier.create();
  net = await mobilenet.load();
  log('models loaded');
  $$('#modelBadge').textContent = 'model: ready';
}

function imgToTensor(file){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.onload=()=>{
      const t = tf.tidy(()=>tf.browser.fromPixels(img).toFloat());
      resolve({img, tensor:t});
    };
    img.onerror=reject;
    img.src = URL.createObjectURL(file);
  });
}

async function addExample(file, classId){
  await ensureModels();
  const {img, tensor} = await imgToTensor(file);
  const activation = net.infer(img, true);
  classifier.addExample(activation, classId);
  activation.dispose(); tensor.dispose();
  totalExamples++;
  $$('#examplesBadge').textContent = '×“×•×’×××•×ª: ' + totalExamples;
}

async function handleFiles(files, classId){
  if(!files || files.length===0) return;
  for(const f of files){
    await addExample(f, classId);
  }
  $$('#statusSpan').textContent = `× ×•×¡×¤×• ${files.length} ×“×•×’×××•×ª ×œ××—×œ×§×” ${classId}`;
}

on($$('#filePick'),'change',e=>{
  const classId = parseInt($$('#classId').value,10)||1;
  handleFiles(e.target.files, classId);
});
on($$('#filePickCam'),'change',e=>{
  const classId = parseInt($$('#classId').value,10)||1;
  handleFiles(e.target.files, classId);
});

// × ×™×”×•×œ ××•×“×œ (×™×™×¦×•×/×™×™×‘×•×/×©××™×¨×” ××§×•××™×ª)
function exportJSON(){
  if(!classifier){ alert('××™×Ÿ ××•×“×œ ×˜×¢×•×Ÿ'); return; }
  const dataset = classifier.getClassifierDataset();
  const dataObj = {};
  Object.keys(dataset).forEach(key=>{
    const data = dataset[key].dataSync();
    dataObj[key] = Array.from(data);
  });
  const json = JSON.stringify({dataObj, shape: dataset[Object.keys(dataset)[0]]?.shape || []});
  const blob = new Blob([json], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'rk_model.json';
  a.click();
}
on($$('#btnExportJSON'),'click', exportJSON);

on($$('#jsonIn'),'change',async e=>{
  const file = e.target.files?.[0]; if(!file) return;
  const text = await file.text();
  restoreFromJSON(text,true);
});

function restoreFromJSON(text, show=true){
  try{
    const obj = JSON.parse(text);
    classifier = knnClassifier.create();
    const dataset = {};
    Object.keys(obj.dataObj).forEach(key=>{
      const tensor = tf.tensor(obj.dataObj[key], obj.shape);
      dataset[key] = tensor;
    });
    classifier.setClassifierDataset(dataset);
    const vectors = Object.values(dataset).reduce((a,t)=>a+(t.shape?.[0]||0),0);
    totalExamples = vectors;
    $$('#examplesBadge').textContent = '×“×•×’×××•×ª: ' + totalExamples;
    if(show) log('âœ… model restored from JSON');
    $$('#modelBadge').textContent = 'model: restored';
  }catch(err){
    log('ERR restore: '+err.message);
    alert('×™×™×‘×•× × ×›×©×œ');
  }
}

// ×©××™×¨×”/×©×—×–×•×¨ ×œ-localStorage
on($$('#btnSaveModel'),'click',()=>{
  if(!classifier){ alert('××™×Ÿ ××•×“×œ'); return; }
  const dataset = classifier.getClassifierDataset();
  const dataObj = {};
  Object.keys(dataset).forEach(key=> dataObj[key] = Array.from(dataset[key].dataSync()));
  const payload = JSON.stringify({dataObj, shape: dataset[Object.keys(dataset)[0]]?.shape || []});
  localStorage.setItem('rk_model', payload);
  const bytes = new Blob([payload]).size;
  log(`ğŸ’¾ × ×©××¨ ××§×•××™×ª â€¢ ~${(bytes/1024).toFixed(1)} KB`);
  $$('#modelBadge').textContent = 'model: saved';
});

on($$('#btnLoadModel'),'click',()=>{
  const payload = localStorage.getItem('rk_model');
  if(!payload){ alert('×œ× × ××¦× ××•×“×œ'); return; }
  restoreFromJSON(payload,false);
  const bytes = new Blob([payload]).size;
  log(`ğŸ“¦ ×©×•×—×–×¨ ××§×•××™×ª â€¢ ${(bytes/1024).toFixed(1)} KB`);
  $$('#modelBadge').textContent = 'model: restored';
});

on($$('#btnNukeExamples'),'click',()=>{
  classifier = knnClassifier.create();
  totalExamples = 0;
  $$('#examplesBadge').textContent = '×“×•×’×××•×ª: â€”';
  log('ğŸ§¹ × ×•×§×”.');
});

// ××ª×—×•×œ ×¨××©×•× ×™
(async function init(){
  $$('#verBadge').textContent = VERSION;
  try{
    await ensureModels();
    $$('#modelBadge').textContent = 'model: ready';
    // × ×¡×™×•×Ÿ ×œ×©×—×–×¨ ××•×˜×•××˜×™×ª
    const payload = localStorage.getItem('rk_model');
    if(payload){ restoreFromJSON(payload,false); log('auto-restore: ok'); }
  }catch(err){
    log('init error: '+err.message);
  }
})();
</script>
</body>
</html>
